<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ë§¤ì¶œ ê´€ë¦¬ ì‹œìŠ¤í…œ</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="./env.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        /* ë¡œê·¸ì¸ í™”ë©´ */
        #loginScreen { display: flex; justify-content: center; align-items: center; min-height: 100vh; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .login-form { background: rgba(255, 255, 255, 0.95); padding: 40px; border-radius: 20px; box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1); backdrop-filter: blur(10px); width: 400px; text-align: center; }
        .login-form h1 { color: #333; margin-bottom: 30px; font-size: 2.2rem; font-weight: 600; }
        .form-group { margin-bottom: 20px; text-align: left; position: relative; }
        .form-group label { display: block; margin-bottom: 8px; color: #555; font-weight: 500; }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 12px 16px; border: 2px solid #e1e5e9; border-radius: 10px; font-size: 16px; transition: border-color 0.3s ease; }
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus { outline: none; border-color: #667eea; }
        .btn { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; padding: 12px 30px; border-radius: 10px; cursor: pointer; font-size: 16px; font-weight: 600; transition: transform 0.25s ease, box-shadow 0.25s ease, background 0.25s ease; margin: 5px; }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 10px 20px rgba(0,0,0,0.2); }
        .btn-secondary { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); }
        .btn-success { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); }
        /* ë©”ì¸ ì‹œìŠ¤í…œ */
        #mainSystem { display: none; background: #f8fafc; min-height: 100vh; }
        .header { background: rgba(255,255,255,0.95); backdrop-filter: blur(10px); padding: 12px 16px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); position: sticky; top: 0; z-index: 200; }
        .header-content { display: flex; justify-content: space-between; align-items: center; max-width: 1200px; margin: 0 auto; gap: 12px; }
        .logo { font-size: 1.4rem; font-weight: 700; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .user-info { display: flex; align-items: center; gap: 10px; }
        .user-name { color: #333; font-weight: 600; }
        /* ëª¨ë°”ì¼ ìƒë‹¨ ë„¤ë¹„ê²Œì´ì…˜ */
        .top-nav { background: rgba(255,255,255,0.9); backdrop-filter: blur(10px); }
        .top-nav-inner { max-width: 1200px; margin: 0 auto; display: flex; align-items: center; justify-content: space-between; padding: 8px 10px; gap: 8px; }
        .tabs-scroll { display: flex; overflow-x: auto; gap: 6px; scrollbar-width: thin; }
        .tab-btn { background: none; border: none; padding: 12px 14px; cursor: pointer; font-size: 14px; font-weight: 600; color: #666; border-bottom: 3px solid transparent; transition: all 0.3s ease; white-space: nowrap; border-radius: 8px; }
        .tab-btn.active { color: #667eea; border-bottom-color: #667eea; background: rgba(102,126,234,0.08); }
        .tab-btn:hover { color: #667eea; background: rgba(102,126,234,0.12); }
        /* íƒ­ ì½˜í…ì¸  */
        .tab-content { display: none; padding: 20px 12px; max-width: 1200px; margin: 0 auto; }
        .tab-content.active { display: block; }
        .section-header { display: flex; align-items: center; gap: 12px; margin-bottom: 18px; padding-bottom: 12px; border-bottom: 2px solid #e2e8f0; }
        .section-icon { width: 36px; height: 36px; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 18px; color: white; }
        .section-title { font-size: 1.4rem; font-weight: 700; color: #2d3748; }
        .card { background: rgba(255,255,255,0.95); backdrop-filter: blur(10px); border-radius: 14px; padding: 18px; margin-bottom: 18px; box-shadow: 0 10px 25px rgba(0,0,0,0.08); border: 1px solid rgba(255,255,255,0.2); transition: box-shadow 0.25s ease, transform 0.25s ease; }
        .card:hover { box-shadow: 0 14px 32px rgba(0,0,0,0.12); transform: translateY(-2px); }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 12px; margin-bottom: 18px; }
        .stat-card { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: #fff; padding: 18px; border-radius: 14px; text-align: center; box-shadow: 0 10px 25px rgba(102, 126, 234, 0.25); }
        .stat-value { font-size: 1.8rem; font-weight: 800; margin-bottom: 6px; }
        .stat-label { font-size: 0.95rem; opacity: 0.95; }
        .filter-section { background: rgba(255,255,255,0.95); padding: 16px; border-radius: 14px; margin-bottom: 18px; box-shadow: 0 5px 15px rgba(0,0,0,0.06); }
        .filter-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 10px; align-items: end; }
        .filter-buttons { display: flex; gap: 8px; flex-wrap: wrap; margin-top: 10px; }
        .filter-btn { background: #e2e8f0; color: #4a5568; border: none; padding: 8px 12px; border-radius: 8px; cursor: pointer; font-size: 13px; font-weight: 600; transition: all 0.3s ease; }
        .filter-btn.active, .filter-btn:hover { background: #667eea; color: #fff; }
        .table-container { overflow-x: auto; border-radius: 12px; box-shadow: 0 10px 25px rgba(0,0,0,0.08); }
        table { width: 100%; border-collapse: collapse; background: white; border-radius: 12px; overflow: hidden; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #e2e8f0; font-size: 14px; }
        th { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; font-weight: 700; position: sticky; top: 0; }
        tr:hover { background: rgba(102,126,234,0.06); }
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 12px; }
        .chart-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 14px; margin-top: 12px; }
        .chart-container { background: rgba(255,255,255,0.95); padding: 16px; border-radius: 14px; box-shadow: 0 10px 25px rgba(0,0,0,0.08); }
        .upload-area { border: 2px dashed #667eea; border-radius: 12px; padding: 20px; text-align: center; cursor: pointer; transition: all 0.3s ease; margin: 12px 0; }
        .upload-area:hover { background: rgba(102,126,234,0.06); }
        .upload-area.dragover { background: rgba(102,126,234,0.1); border-color: #764ba2; }
        .calculation-panel { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color: #fff; padding: 16px; border-radius: 14px; margin: 12px 0; }
        .calc-row { display: flex; justify-content: space-between; margin: 6px 0; padding: 4px 0; }
        .calc-row.total { border-top: 2px solid rgba(255,255,255,0.35); margin-top: 8px; padding-top: 8px; font-weight: 700; font-size: 1.05rem; }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); backdrop-filter: blur(5px); }
        .modal-content { background: white; margin: 15% auto; padding: 18px; border-radius: 14px; width: 92%; max-width: 500px; box-shadow: 0 20px 40px rgba(0,0,0,0.18); }
        .modal h3 { color: #667eea; margin-bottom: 10px; }
        .close { color: #aaa; float: right; font-size: 26px; font-weight: bold; cursor: pointer; line-height: 1; }
        .close:hover { color: #667eea; }
        @media (max-width: 768px) {
            .login-form { width: 92%; padding: 26px 18px; }
            .header-content { flex-direction: column; align-items: stretch; }
            .tab-btn { padding: 10px 12px; font-size: 13px; }
            th, td { padding: 10px 8px; font-size: 13px; }
        }
    </style>
    <script>
        // í™˜ê²½ê°’ì—ì„œ Supabase ì´ˆê¸°í™”
        let supabaseClient = null;
        function initSupabase() {
            if (!window.SUPABASE_URL || !window.SUPABASE_ANON_KEY) {
                console.error('Supabase í™˜ê²½ë³€ìˆ˜ê°€ ì—†ìŠµë‹ˆë‹¤. env.jsë¥¼ í™•ì¸í•˜ì„¸ìš”.');
                return null;
            }
            return window.supabase.createClient(window.SUPABASE_URL, window.SUPABASE_ANON_KEY);
        }
    </script>
</head>
<body>
    <!-- ë¡œê·¸ì¸ í™”ë©´ -->
    <div id="loginScreen">
        <div class="login-form">
            <h1>ğŸ’¼ ë§¤ì¶œ ê´€ë¦¬</h1>
            <form id="loginForm">
                <div class="form-group">
                    <label for="businessNumber">ì‚¬ì—…ìë“±ë¡ë²ˆí˜¸</label>
                    <input type="text" id="businessNumber" placeholder="000-00-00000" maxlength="12" required />
                </div>
                <div class="form-group">
                    <label for="businessName">ì‚¬ì—…ì²´ëª…</label>
                    <input type="text" id="businessName" placeholder="ì‚¬ì—…ì²´ëª…ì„ ì…ë ¥í•˜ì„¸ìš”" required />
                </div>
                <div class="form-group">
                    <label for="ownerName">ëŒ€í‘œìëª…</label>
                    <input type="text" id="ownerName" placeholder="ëŒ€í‘œìëª…ì„ ì…ë ¥í•˜ì„¸ìš”" required />
                </div>
                <button type="submit" class="btn">ë¡œê·¸ì¸ / ë“±ë¡</button>
            </form>
        </div>
    </div>

    <!-- ë©”ì¸ ì‹œìŠ¤í…œ -->
    <div id="mainSystem">
        <div class="header">
            <div class="header-content">
                <div class="logo">ğŸ’¼ ë§¤ì¶œ ê´€ë¦¬ ì‹œìŠ¤í…œ</div>
                <div class="user-info">
                    <span class="user-name" id="displayBusinessName"></span>
                    <button class="btn btn-secondary" id="logoutBtn">ë¡œê·¸ì•„ì›ƒ</button>
                </div>
            </div>
        </div>

        <!-- ìƒë‹¨ ëª¨ë°”ì¼ ë„¤ë¹„ê²Œì´ì…˜ -->
        <div class="top-nav">
            <div class="top-nav-inner">
                <div class="tabs-scroll">
                    <button class="tab-btn active" data-tab="dashboard">ğŸ“Š ëŒ€ì‹œë³´ë“œ</button>
                    <button class="tab-btn" data-tab="sales">ğŸ’° ë§¤ì¶œ ë“±ë¡</button>
                    <button class="tab-btn" data-tab="products">ğŸ“¦ ìƒí’ˆ ê´€ë¦¬</button>
                    <button class="tab-btn" data-tab="expenses">ğŸ’¸ ì§€ì¶œ ê´€ë¦¬</button>
                    <button class="tab-btn" data-tab="reports">ğŸ“ˆ ë¦¬í¬íŠ¸</button>
                </div>
            </div>
        </div>

        <!-- ëŒ€ì‹œë³´ë“œ -->
        <div class="tab-content active" id="dashboard">
            <div class="section-header">
                <div class="section-icon" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">ğŸ“Š</div>
                <div class="section-title">ëŒ€ì‹œë³´ë“œ</div>
            </div>
            <div class="filter-section">
                <h3>ğŸ“… ë‚ ì§œ í•„í„°</h3>
                <div class="filter-grid">
                    <div class="form-group">
                        <label>ì‹œì‘ì¼</label>
                        <input type="date" id="startDate" />
                    </div>
                    <div class="form-group">
                        <label>ì¢…ë£Œì¼</label>
                        <input type="date" id="endDate" />
                    </div>
                </div>
                <div class="filter-buttons">
                    <button class="filter-btn" data-range="today">ì˜¤ëŠ˜</button>
                    <button class="filter-btn active" data-range="month">ì´ë²ˆë‹¬</button>
                    <button class="filter-btn" data-range="year">ì˜¬í•´</button>
                    <button class="filter-btn" data-range="all">ì „ì²´</button>
                    <button class="filter-btn" id="resetDate">ì´ˆê¸°í™”</button>
                </div>
            </div>
            <div class="stats-grid">
                <div class="stat-card"><div class="stat-value" id="todaySales">â‚©0</div><div class="stat-label">ì˜¤ëŠ˜ì˜ ë§¤ì¶œ</div></div>
                <div class="stat-card"><div class="stat-value" id="monthProfit">â‚©0</div><div class="stat-label">ì´ë²ˆë‹¬ ìˆœìµ</div></div>
                <div class="stat-card"><div class="stat-value" id="profitRate">0%</div><div class="stat-label">ìˆ˜ìµë¥ </div></div>
                <div class="stat-card"><div class="stat-value" id="activePlatforms">0</div><div class="stat-label">í™œì„± í”Œë«í¼ ìˆ˜</div></div>
            </div>
            <div class="chart-grid">
                <div class="chart-container"><h3>ğŸ“ˆ ì›”ë³„ ë§¤ì¶œ ì¶”ì´</h3><canvas id="monthlySalesChart"></canvas></div>
                <div class="chart-container"><h3>ğŸ“… ì¼ë³„ ë§¤ì¶œ</h3><canvas id="dailySalesChart"></canvas></div>
                <div class="chart-container"><h3>ğŸª í”Œë«í¼ë³„ ë§¤ì¶œ ë¹„ì¤‘</h3><canvas id="platformSalesChart"></canvas></div>
                <div class="chart-container"><h3>ğŸ’¸ ì§€ì¶œ ë¶„ì„</h3><canvas id="expenseChart"></canvas></div>
            </div>
        </div>

        <!-- ë§¤ì¶œ ë“±ë¡ -->
        <div class="tab-content" id="sales">
            <div class="section-header">
                <div class="section-icon" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">ğŸ’°</div>
                <div class="section-title">ë§¤ì¶œ ë“±ë¡</div>
            </div>
            <div class="card">
                <h3>âœï¸ ìˆ˜ë™ ë“±ë¡</h3>
                <form id="salesForm">
                    <div class="form-grid">
                        <div class="form-group"><label>í”Œë«í¼ *</label><select id="salesPlatform" required></select></div>
                        <div class="form-group">
                            <label>ìƒí’ˆëª… *</label>
                            <input type="text" id="salesProductName" placeholder="ìƒí’ˆëª… ë˜ëŠ” ë§¤ì¹­ëª…ìœ¼ë¡œ ê²€ìƒ‰" required />
                            <div id="productSuggestions" style="display:none; position:absolute; background:#fff; border:1px solid #ddd; border-radius:10px; max-height:240px; overflow-y:auto; width:100%; z-index:10;"></div>
                        </div>
                        <div class="form-group"><label>ì˜µì…˜ëª…</label><input type="text" id="salesOption" placeholder="ì˜µì…˜ëª… (ì„ íƒ)" /></div>
                        <div class="form-group"><label>íŒë§¤ê°€ *</label><input type="number" id="salesPrice" placeholder="íŒë§¤ê°€" required /></div>
                        <div class="form-group"><label>ë°°ì†¡ë¹„</label><input type="number" id="salesShipping" value="0" /></div>
                        <div class="form-group"><label>ìˆ˜ìˆ˜ë£Œ(%)</label><input type="number" id="salesFeePercent" step="0.1" placeholder="í”Œë«í¼ ê¸°ë³¸ê°’ ìë™ ë°˜ì˜ / ìˆ˜ë™ ê°€ëŠ¥" /></div>
                        <div class="form-group"><label>íŒë§¤ì¼ *</label><input type="date" id="salesDate" required /></div>
                        <div class="form-group"><label>ì£¼ë¬¸ë²ˆí˜¸</label><input type="text" id="salesOrderNumber" placeholder="ì£¼ë¬¸ë²ˆí˜¸ (ì„ íƒ)" /></div>
                    </div>
                    <div class="calculation-panel">
                        <h4>ğŸ’° ì‹¤ì‹œê°„ ê³„ì‚°</h4>
                        <div class="calc-row"><span>ë§¤ì¶œ(íŒë§¤ê°€):</span><span id="calcTotalSales">â‚©0</span></div>
                        <div class="calc-row"><span>ë¶€ê°€ì„¸ (10%):</span><span id="calcVAT">â‚©0</span></div>
                        <div class="calc-row"><span>ìˆ˜ìˆ˜ë£Œ:</span><span id="calcFee">â‚©0</span></div>
                        <div class="calc-row"><span>ë°°ì†¡ë¹„:</span><span id="calcShip">â‚©0</span></div>
                        <div class="calc-row total"><span>ìˆœìµ(ì¶”ì •):</span><span id="calcProfit">â‚©0</span></div>
                        <div class="calc-row"><span>ìˆ˜ìµë¥ (ì¶”ì •):</span><span id="calcProfitRate">0%</span></div>
                    </div>
                    <button type="submit" class="btn btn-success">ğŸ’¾ ë§¤ì¶œ ë“±ë¡</button>
                </form>
            </div>
            <div class="card">
                <h3>ğŸ“„ ì—‘ì…€ ì—…ë¡œë“œ</h3>
                <p>í¬ë§·: ì‡¼í•‘ëª°, ì‡¼í•‘ëª°ì£¼ë¬¸ë²ˆí˜¸, ì˜¨ë¼ì¸ìƒí’ˆëª…, ì˜µì…˜, ì£¼ë¬¸ìˆ˜ëŸ‰</p>
                <div class="upload-area" id="salesUploadArea"><p>ğŸ“ ì—‘ì…€ íŒŒì¼ì„ ë“œë˜ê·¸í•˜ê±°ë‚˜ í´ë¦­í•˜ì—¬ ì—…ë¡œë“œ</p><input type="file" id="salesExcelFile" accept=".xlsx,.xls,.csv" style="display: none;" /></div>
                <button class="btn" id="chooseSalesFile">ğŸ“ íŒŒì¼ ì„ íƒ</button>
                <button class="btn btn-success" id="processSalesBtn">ğŸ“Š ì—…ë¡œë“œ ì²˜ë¦¬</button>
            </div>
            <div class="card">
                <h3>ğŸ“‹ ë§¤ì¶œ ëª©ë¡</h3>
                <div class="table-container">
                    <table id="salesTable">
                        <thead>
                            <tr>
                                <th>íŒë§¤ì¼</th><th>ë“±ë¡ì¼</th><th>í”Œë«í¼</th><th>ìƒí’ˆëª…</th><th>ì˜µì…˜</th><th>ì£¼ë¬¸ë²ˆí˜¸</th><th>íŒë§¤ê°€</th><th>ë¶€ê°€ì„¸</th><th>ì›ê°€</th><th>ìˆ˜ìˆ˜ë£Œ</th><th>ë°°ì†¡ë¹„</th><th>ìˆœìµ</th><th>ìˆ˜ìµë¥ </th><th>ê´€ë¦¬</th>
                            </tr>
                        </thead>
                        <tbody id="salesTableBody"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- ìƒí’ˆ ê´€ë¦¬ -->
        <div class="tab-content" id="products">
            <div class="section-header">
                <div class="section-icon" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">ğŸ“¦</div>
                <div class="section-title">ìƒí’ˆ ê´€ë¦¬</div>
            </div>
            <div class="card">
                <h3>â• ìƒí’ˆ ë“±ë¡</h3>
                <form id="productForm">
                    <div class="form-grid">
                        <div class="form-group"><label>ìƒí’ˆëª… *</label><input type="text" id="productName" required placeholder="ì‹¤ì œ ìƒí’ˆëª…" /></div>
                        <div class="form-group"><label>ê¸°ë³¸ ì›ê°€ *</label><input type="number" id="productCost" required placeholder="ê¸°ë³¸ ì›ê°€" /></div>
                        <div class="form-group"><label>í”Œë«í¼ *</label><select id="productPlatform" required></select></div>
                        <div class="form-group"><label>í”Œë«í¼ë³„ íŒë§¤ê°€ *</label><input type="number" id="productPrice" required placeholder="íŒë§¤ê°€" /></div>
                    </div>
                    <div class="form-group">
                        <label>ë§¤ì¹­ ìƒí’ˆëª…</label>
                        <textarea id="productMatching" placeholder="í”Œë«í¼:ìƒí’ˆëª… í˜•íƒœë¡œ ì…ë ¥ (ì¤„ë°”ê¿ˆìœ¼ë¡œ ì—¬ëŸ¬ê°œ ì…ë ¥ ê°€ëŠ¥)&#10;ì˜ˆì‹œ:&#10;ì¿ íŒ¡:ìƒí’ˆëª…A&#10;11ë²ˆê°€:ìƒí’ˆëª…B" rows="4" style="width: 100%; resize: vertical;"></textarea>
                    </div>
                    <button type="submit" class="btn btn-success">ğŸ’¾ ìƒí’ˆ ë“±ë¡</button>
                </form>
            </div>
            <div class="card">
                <h3>ğŸª í”Œë«í¼ ê´€ë¦¬</h3>
                <div style="display: flex; gap: 10px; margin-bottom: 12px; flex-wrap: wrap;">
                    <input type="text" id="newPlatformName" placeholder="í”Œë«í¼ëª…" style="flex: 1; min-width: 180px;" />
                    <input type="number" id="newPlatformFee" placeholder="ê¸°ë³¸ ìˆ˜ìˆ˜ë£Œ (%)" step="0.1" style="flex: 1; min-width: 180px;" />
                    <button class="btn" id="addPlatformBtn">â• í”Œë«í¼ ì¶”ê°€</button>
                </div>
                <div class="table-container">
                    <table id="platformTable">
                        <thead><tr><th>í”Œë«í¼ëª…</th><th>ê¸°ë³¸ ìˆ˜ìˆ˜ë£Œ (%)</th><th>ê´€ë¦¬</th></tr></thead>
                        <tbody id="platformTableBody"></tbody>
                    </table>
                </div>
            </div>
            <div class="card">
                <h3>ğŸ“Š ìƒí’ˆ ì¼ê´„ ë“±ë¡</h3>
                <p>í¬ë§·: ì‹¤ì œìƒí’ˆëª…, ê¸°ë³¸ì›ê°€, ê¶Œì¥íŒë§¤ê°€, ë§¤ì¹­ìƒí’ˆëª…</p>
                <button class="btn btn-secondary" id="downloadProductTemplateBtn">ğŸ“¥ í…œí”Œë¦¿ ë‹¤ìš´ë¡œë“œ</button>
                <div class="upload-area" id="productUploadArea"><p>ğŸ“ ìƒí’ˆ ì—‘ì…€ íŒŒì¼ì„ ë“œë˜ê·¸í•˜ê±°ë‚˜ í´ë¦­í•˜ì—¬ ì—…ë¡œë“œ</p><input type="file" id="productExcelFile" accept=".xlsx,.xls,.csv" style="display:none;" /></div>
                <button class="btn" id="chooseProductFile">ğŸ“ íŒŒì¼ ì„ íƒ</button>
                <button class="btn btn-success" id="processProductBtn">ğŸ“Š ì—…ë¡œë“œ ì²˜ë¦¬</button>
            </div>
            <div class="card">
                <h3>ğŸ“¦ ìƒí’ˆ ëª©ë¡</h3>
                <div class="table-container">
                    <table id="productTable">
                        <thead><tr><th>ìƒí’ˆëª…</th><th>í”Œë«í¼</th><th>ì›ê°€</th><th>íŒë§¤ê°€</th><th>ì˜ˆìƒ ìˆ˜ìµë¥ </th><th>ê´€ë¦¬</th></tr></thead>
                        <tbody id="productTableBody"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- ì§€ì¶œ ê´€ë¦¬ -->
        <div class="tab-content" id="expenses">
            <div class="section-header">
                <div class="section-icon" style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);">ğŸ’¸</div>
                <div class="section-title">ì§€ì¶œ ê´€ë¦¬</div>
            </div>
            <div class="card">
                <h3>â• ì§€ì¶œ ë“±ë¡</h3>
                <form id="expenseForm">
                    <div class="form-grid">
                        <div class="form-group"><label>êµ¬ë¶„ *</label><select id="expenseType" required><option value="">êµ¬ë¶„ ì„ íƒ</option><option value="ì‚¬ì—…">ì‚¬ì—…</option><option value="ê°œì¸">ê°œì¸</option></select></div>
                        <div class="form-group"><label>ì¹´í…Œê³ ë¦¬ *</label><select id="expenseCategory" required><option value="">ì¹´í…Œê³ ë¦¬ ì„ íƒ</option><option value="ì¬ë£Œë¹„">ì¬ë£Œë¹„</option><option value="ìš´ì†¡ë¹„">ìš´ì†¡ë¹„</option><option value="ê´‘ê³ ë¹„">ê´‘ê³ ë¹„</option><option value="ì‚¬ë¬´ìš©í’ˆ">ì‚¬ë¬´ìš©í’ˆ</option><option value="í†µì‹ ë¹„">í†µì‹ ë¹„</option><option value="ì„ëŒ€ë£Œ">ì„ëŒ€ë£Œ</option><option value="ê¸°íƒ€">ê¸°íƒ€</option></select></div>
                        <div class="form-group"><label>ê¸ˆì•¡ *</label><input type="number" id="expenseAmount" required placeholder="ì§€ì¶œ ê¸ˆì•¡" /></div>
                        <div class="form-group"><label>ë‚ ì§œ *</label><input type="date" id="expenseDate" required /></div>
                        <div class="form-group" style="grid-column: 1 / -1;"><label>ë‚´ìš©</label><input type="text" id="expenseDescription" placeholder="ì§€ì¶œ ë‚´ìš© ì„¤ëª…" /></div>
                    </div>
                    <button type="submit" class="btn btn-success">ğŸ’¾ ì§€ì¶œ ë“±ë¡</button>
                </form>
            </div>
            <div class="card">
                <h3>ğŸ’¸ ì§€ì¶œ ëª©ë¡</h3>
                <div style="margin-bottom: 12px; display:flex; gap:14px; flex-wrap:wrap;">
                    <span><strong>ì´ ì§€ì¶œ:</strong> <span id="totalExpense">â‚©0</span></span>
                    <span><strong>ì‚¬ì—… ì§€ì¶œ:</strong> <span id="businessExpense">â‚©0</span></span>
                    <span><strong>ê°œì¸ ì§€ì¶œ:</strong> <span id="personalExpense">â‚©0</span></span>
                </div>
                <div class="table-container">
                    <table id="expenseTable">
                        <thead><tr><th>ë‚ ì§œ</th><th>êµ¬ë¶„</th><th>ì¹´í…Œê³ ë¦¬</th><th>ê¸ˆì•¡</th><th>ë‚´ìš©</th><th>ê´€ë¦¬</th></tr></thead>
                        <tbody id="expenseTableBody"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- ë¦¬í¬íŠ¸ -->
        <div class="tab-content" id="reports">
            <div class="section-header">
                <div class="section-icon" style="background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);">ğŸ“ˆ</div>
                <div class="section-title">ë¦¬í¬íŠ¸</div>
            </div>
            <div class="stats-grid">
                <div class="stat-card"><div class="stat-value" id="reportTotalSales">â‚©0</div><div class="stat-label">ì´ ë§¤ì¶œ</div></div>
                <div class="stat-card" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);"><div class="stat-value" id="reportTotalProfit">â‚©0</div><div class="stat-label">ì´ ìˆœìµ</div></div>
                <div class="stat-card" style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);"><div class="stat-value" id="reportAvgProfitRate">0%</div><div class="stat-label">í‰ê·  ìˆ˜ìµë¥ </div></div>
                <div class="stat-card" style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);"><div class="stat-value" id="reportTotalCount">0</div><div class="stat-label">íŒë§¤ ê±´ìˆ˜</div></div>
            </div>
            <div class="chart-grid">
                <div class="chart-container"><h3>ğŸ“ˆ ì›”ë³„ ë§¤ì¶œ vs ìˆœìµ</h3><canvas id="reportMonthlySalesProfit"></canvas></div>
                <div class="chart-container"><h3>ğŸª í”Œë«í¼ë³„ ì„±ê³¼</h3><canvas id="reportPlatformPerformance"></canvas></div>
                <div class="chart-container"><h3>ğŸ“¦ ìƒìœ„ íŒë§¤ ìƒí’ˆ</h3><canvas id="reportTopProducts"></canvas></div>
                <div class="chart-container"><h3>ğŸ’° ìˆ˜ìµë¥  ë¶„í¬</h3><canvas id="reportProfitDistribution"></canvas></div>
            </div>
        </div>
    </div>

    <!-- ëª¨ë‹¬ ì°½ -->
    <div id="modal" class="modal">
        <div class="modal-content">
            <span class="close" id="modalClose">&times;</span>
            <h3 id="modalTitle">ì•Œë¦¼</h3>
            <div id="modalMessage"></div>
            <div style="text-align: center; margin-top: 12px;"><button class="btn" id="modalOk">í™•ì¸</button></div>
        </div>
    </div>

    <script>
        // ì „ì—­ ìƒíƒœ
        let currentUser = null;
        let salesData = [];
        let productData = [];
        let platformData = [];
        let expenseData = [];
        let charts = {};

        // ìœ í‹¸
        const fmtKRW = (n) => `â‚©${Math.round(n || 0).toLocaleString()}`;
        const unique = (arr) => Array.from(new Set(arr));

        // ìƒí’ˆ ê²€ì¦ ìœ í‹¸: í”Œë«í¼/ë§¤ì¹­ê¹Œì§€ ê³ ë ¤í•´ ë“±ë¡ ì—¬ë¶€ í™•ì¸
        function isKnownProductName(inputName, platformOpt) {
            const name = (inputName || '').trim();
            if (!name) return false;
            return productData.some(p => {
                if ((p.name || '') === name && (!platformOpt || p.platform === platformOpt)) return true;
                if (!Array.isArray(p.matching)) return false;
                return p.matching.some(m => {
                    const raw = (m || '').trim();
                    if (!raw) return false;
                    if (raw.includes(':')) {
                        const [plat, alias] = raw.split(':');
                        if (platformOpt) return plat === platformOpt && alias === name;
                        return alias === name || raw === name;
                    }
                    return raw === name;
                });
            });
        }

        // ëª¨ë‹¬
        function showModal(title, message) {
            document.getElementById('modalTitle').textContent = title;
            document.getElementById('modalMessage').textContent = message;
            document.getElementById('modal').style.display = 'block';
        }
        function closeModal() { document.getElementById('modal').style.display = 'none'; }

        // ì´ˆê¸°í™”
        document.addEventListener('DOMContentLoaded', async () => {
            supabaseClient = initSupabase();
            bindStaticEvents();
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('salesDate').value = today;
            document.getElementById('expenseDate').value = today;
            const savedUser = JSON.parse(localStorage.getItem('currentUser') || 'null');
            if (savedUser) { currentUser = savedUser; await postLogin(); }
        });

        function bindStaticEvents() {
            document.getElementById('loginForm').addEventListener('submit', handleLogin);
            document.getElementById('logoutBtn').addEventListener('click', logout);
            document.getElementById('salesForm').addEventListener('input', calculateSales);
            document.getElementById('salesForm').addEventListener('submit', handleSalesSubmit);
            document.getElementById('productForm').addEventListener('submit', handleProductSubmit);
            document.getElementById('expenseForm').addEventListener('submit', handleExpenseSubmit);
            document.getElementById('modalClose').addEventListener('click', closeModal);
            document.getElementById('modalOk').addEventListener('click', closeModal);
            document.getElementById('resetDate').addEventListener('click', resetDateFilter);
            document.getElementById('chooseSalesFile').addEventListener('click', () => document.getElementById('salesExcelFile').click());
            document.getElementById('chooseProductFile').addEventListener('click', () => document.getElementById('productExcelFile').click());
            document.getElementById('processSalesBtn').addEventListener('click', processSalesExcel);
            document.getElementById('processProductBtn').addEventListener('click', processProductExcel);
            document.getElementById('downloadProductTemplateBtn').addEventListener('click', downloadProductTemplate);
            // íƒ­
            document.querySelectorAll('.tab-btn').forEach(btn => btn.addEventListener('click', () => showTab(btn.dataset.tab, btn)));
            // ë‚ ì§œ í€µí•„í„°
            document.querySelectorAll('.filter-btn[data-range]').forEach(btn => btn.addEventListener('click', () => setDateFilter(btn.dataset.range, btn)));
            // ì—…ë¡œë“œ ë“œë˜ê·¸
            setupFileUpload();
            // ìë™ì™„ì„± ì™¸ë¶€ í´ë¦­ ë‹«ê¸°
            document.addEventListener('click', (e) => {
                const suggestions = document.getElementById('productSuggestions');
                const input = document.getElementById('salesProductName');
                if (suggestions && !suggestions.contains(e.target) && e.target !== input) { suggestions.style.display = 'none'; }
            });
            // ìë™ì™„ì„± ì…ë ¥ ë°”ì¸ë”©
            document.getElementById('salesProductName').addEventListener('input', (e) => searchProducts(e.target.value));
        }

        async function handleLogin(e) {
            e.preventDefault();
            const businessNumber = document.getElementById('businessNumber').value;
            const businessName = document.getElementById('businessName').value;
            const ownerName = document.getElementById('ownerName').value;
            if (!businessNumber || !businessName || !ownerName) { showModal('ì˜¤ë¥˜', 'ëª¨ë“  í•„ë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.'); return; }
            const numberOnly = businessNumber.replace(/[^\d]/g, '');
            if (numberOnly.length !== 10) { showModal('ì˜¤ë¥˜', 'ì˜¬ë°”ë¥¸ ì‚¬ì—…ìë“±ë¡ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.'); return; }
            currentUser = { businessNumber, businessName, ownerName, loginDate: new Date().toISOString() };
            localStorage.setItem('currentUser', JSON.stringify(currentUser));
            await postLogin();
            showModal('ì„±ê³µ', 'ë¡œê·¸ì¸ë˜ì—ˆìŠµë‹ˆë‹¤!');
        }

        async function postLogin() {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('mainSystem').style.display = 'block';
            document.getElementById('displayBusinessName').textContent = currentUser.businessName;
            initializeDateFilter();
            await ensureDefaultPlatforms();
            await reloadAllData();
            updateAllTables();
            updateDashboard();
        }

        function logout() {
            if (confirm('ë¡œê·¸ì•„ì›ƒ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                localStorage.removeItem('currentUser');
                currentUser = null;
                document.getElementById('loginScreen').style.display = 'flex';
                document.getElementById('mainSystem').style.display = 'none';
                document.getElementById('loginForm').reset();
            }
        }

        function showTab(tabName, btn) {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            if (btn) btn.classList.add('active');
            document.getElementById(tabName).classList.add('active');
            if (tabName === 'reports') setTimeout(() => updateReportsCharts(), 100);
        }

        // Supabase CRUD helpers
        async function reloadAllData() {
            const bn = currentUser.businessNumber;
            const [salesRes, productRes, platformRes, expenseRes] = await Promise.all([
                supabaseClient.from('sales').select('*').eq('business_number', bn).order('date', { ascending: true }),
                supabaseClient.from('products').select('*').eq('business_number', bn).order('name'),
                supabaseClient.from('platforms').select('*').eq('business_number', bn).order('name'),
                supabaseClient.from('expenses').select('*').eq('business_number', bn).order('date', { ascending: true })
            ]);
            if (salesRes.error) console.error(salesRes.error);
            if (productRes.error) console.error(productRes.error);
            if (platformRes.error) console.error(platformRes.error);
            if (expenseRes.error) console.error(expenseRes.error);
            salesData = salesRes.data || [];
            productData = productRes.data || [];
            platformData = platformRes.data || [];
            expenseData = expenseRes.data || [];
            updatePlatformSelects();
        }

        async function ensureDefaultPlatforms() {
            const bn = currentUser.businessNumber;
            const { data, error } = await supabaseClient.from('platforms').select('id').eq('business_number', bn).limit(1);
            if (error) { console.error(error); return; }
            if (!data || data.length === 0) {
                const defaults = [
                    { name: 'ì¿ íŒ¡', fee: 8.8 },
                    { name: '11ë²ˆê°€', fee: 9.0 },
                    { name: 'ì§€ë§ˆì¼“', fee: 9.5 },
                    { name: 'ì˜¥ì…˜', fee: 9.5 },
                    { name: 'ë„¤ì´ë²„ìŠ¤í† ì–´íŒœ', fee: 5.5 }
                ].map(p => ({ ...p, business_number: bn }));
                const { error: insErr } = await supabaseClient.from('platforms').insert(defaults);
                if (insErr) console.error(insErr);
            }
        }

        // í”Œë«í¼
        function updatePlatformSelects() {
            ['salesPlatform', 'productPlatform'].forEach(selectId => {
                const select = document.getElementById(selectId);
                const cur = select.value;
                select.innerHTML = '<option value="">í”Œë«í¼ ì„ íƒ</option>';
                platformData.forEach(p => { const o = document.createElement('option'); o.value = p.name; o.textContent = p.name; select.appendChild(o); });
                select.value = cur;
            });
            updatePlatformTable();
        }
        document.getElementById('addPlatformBtn').addEventListener('click', async () => {
            const name = document.getElementById('newPlatformName').value.trim();
            const fee = parseFloat(document.getElementById('newPlatformFee').value);
            if (!name || isNaN(fee)) { showModal('ì˜¤ë¥˜', 'í”Œë«í¼ëª…ê³¼ ìˆ˜ìˆ˜ë£Œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.'); return; }
            if (platformData.find(p => p.name === name)) { showModal('ì˜¤ë¥˜', 'ì´ë¯¸ ì¡´ì¬í•˜ëŠ” í”Œë«í¼ì…ë‹ˆë‹¤.'); return; }
            const { error } = await supabaseClient.from('platforms').insert([{ name, fee, business_number: currentUser.businessNumber }]);
            if (error) { showModal('ì˜¤ë¥˜', 'í”Œë«í¼ ì¶”ê°€ ì‹¤íŒ¨'); return; }
            document.getElementById('newPlatformName').value = '';
            document.getElementById('newPlatformFee').value = '';
            await reloadAllData();
            showModal('ì„±ê³µ', 'í”Œë«í¼ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.');
        });
        async function deletePlatform(index) {
            const row = platformData[index]; if (!row) return;
            if (!confirm('í”Œë«í¼ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
            const { error } = await supabaseClient.from('platforms').delete().eq('id', row.id).eq('business_number', currentUser.businessNumber);
            if (error) { showModal('ì˜¤ë¥˜', 'ì‚­ì œ ì‹¤íŒ¨'); return; }
            await reloadAllData();
        }
        function updatePlatformTable() {
            const tbody = document.getElementById('platformTableBody');
            tbody.innerHTML = '';
            platformData.forEach((platform, index) => {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${platform.name}</td>
                    <td>${platform.fee}%</td>
                    <td>
                        <button class="btn btn-secondary" style="padding:6px 10px; font-size:12px;" onclick="editPlatform(${index})">ìˆ˜ì •</button>
                        <button class="btn" style="padding:6px 10px; font-size:12px; background:#f56565; color:#fff;" onclick="deletePlatform(${index})">ì‚­ì œ</button>
                    </td>`;
            });
        }

        // ìë™ì™„ì„±
        function searchProducts(query) {
            const suggestions = document.getElementById('productSuggestions');
            if (!query || query.length < 1) { suggestions.style.display = 'none'; return; }
            const q = query.toLowerCase();
            const matches = productData.filter(product => {
                const n = (product.name || '').toLowerCase();
                const m = Array.isArray(product.matching) ? product.matching.map(x => (x||'').toLowerCase()).join(' ') : '';
                return n.includes(q) || m.includes(q);
            });
            if (matches.length > 0) {
                suggestions.innerHTML = matches.map(product =>
                    `<div onclick="selectProduct('${(product.name || '').replace(/'/g, "\'")}')" style="padding:10px; cursor:pointer; border-bottom:1px solid #eee;">${product.name} (${product.platform}) - ${fmtKRW(product.price)}</div>`
                ).join('');
                suggestions.style.display = 'block';
            } else { suggestions.style.display = 'none'; }
        }
        function selectProduct(productName) {
            const product = productData.find(p => p.name === productName);
            if (product) {
                document.getElementById('salesProductName').value = product.name || '';
                document.getElementById('salesPlatform').value = product.platform || '';
                document.getElementById('salesPrice').value = product.price || 0;
                // í”Œë«í¼ ê¸°ë³¸ ìˆ˜ìˆ˜ë£Œ ìë™ ë°˜ì˜
                const pf = platformData.find(p => p.name === product.platform);
                document.getElementById('salesFeePercent').value = pf ? pf.fee : '';
                calculateSales();
            }
            document.getElementById('productSuggestions').style.display = 'none';
        }

        // ê³„ì‚°
        function calculateSales() {
            const price = parseFloat(document.getElementById('salesPrice').value) || 0;
            const shipping = parseFloat(document.getElementById('salesShipping').value) || 0;
            const platform = document.getElementById('salesPlatform').value;
            const manualFeePercent = document.getElementById('salesFeePercent').value;
            const platformInfo = platformData.find(p => p.name === platform);
            const feeRate = (manualFeePercent !== '' ? parseFloat(manualFeePercent) : (platformInfo ? platformInfo.fee : 0)) / 100;
            const totalSales = price;
            const vat = totalSales * 0.1;
            const fee = totalSales * (isNaN(feeRate) ? 0 : feeRate);
            const profit = totalSales - vat - shipping - fee; // ê°„ì†Œí™”ëœ ì¶”ì •
            const profitRate = totalSales > 0 ? (profit / totalSales * 100) : 0;
            document.getElementById('calcTotalSales').textContent = fmtKRW(totalSales);
            document.getElementById('calcVAT').textContent = fmtKRW(vat);
            document.getElementById('calcFee').textContent = fmtKRW(fee);
            document.getElementById('calcShip').textContent = fmtKRW(shipping);
            document.getElementById('calcProfit').textContent = fmtKRW(profit);
            document.getElementById('calcProfitRate').textContent = `${profitRate.toFixed(1)}%`;
        }

        // ë§¤ì¶œ ë“±ë¡
        async function handleSalesSubmit(e) {
            e.preventDefault();
            const feePercent = document.getElementById('salesFeePercent').value;
            const rec = {
                business_number: currentUser.businessNumber,
                date: document.getElementById('salesDate').value,
                platform: document.getElementById('salesPlatform').value,
                product_name: document.getElementById('salesProductName').value,
                price: parseFloat(document.getElementById('salesPrice').value),
                quantity: 1,
                cost: 0,
                shipping: parseFloat(document.getElementById('salesShipping').value) || 0,
                option: document.getElementById('salesOption').value || '',
                order_number: document.getElementById('salesOrderNumber').value || '',
                fee_percent: feePercent === '' ? null : parseFloat(feePercent),
                registered_at: new Date().toISOString()
            };
            // ë¯¸ë“±ë¡ ìƒí’ˆëª… ê²€ì¦
            const platformName = rec.platform;
            const productKnown = isKnownProductName(rec.product_name, platformName);
            if (!productKnown) {
                showModal('í™•ì¸ í•„ìš”', `ìƒí’ˆ ê´€ë¦¬ì— ë“±ë¡ë˜ì§€ ì•Šì€ ìƒí’ˆëª…ì…ë‹ˆë‹¤: "${rec.product_name}"`);
                return;
            }
            const { error } = await supabaseClient.from('sales').insert([rec]);
            if (error) { showModal('ì˜¤ë¥˜', 'ë§¤ì¶œ ë“±ë¡ ì‹¤íŒ¨'); return; }
            (document.getElementById('salesForm')).reset();
            document.getElementById('salesDate').value = new Date().toISOString().split('T')[0];
            calculateSales();
            await reloadAllData();
            updateSalesTable();
            updateDashboard();
            showModal('ì„±ê³µ', 'ë§¤ì¶œì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤!');
        }

        // í”Œë«í¼ ìˆ˜ì •
        async function editPlatform(index) {
            const row = platformData[index]; if (!row) return;
            const newName = prompt('í”Œë«í¼ëª…ì„ ì…ë ¥í•˜ì„¸ìš”', row.name);
            if (newName === null) return;
            const feeStr = prompt('ê¸°ë³¸ ìˆ˜ìˆ˜ë£Œ(%)ë¥¼ ì…ë ¥í•˜ì„¸ìš”', String(row.fee));
            if (feeStr === null) return;
            const newFee = parseFloat(feeStr);
            if (!newName.trim() || isNaN(newFee)) { showModal('ì˜¤ë¥˜', 'ì˜¬ë°”ë¥¸ ê°’ì´ ì•„ë‹™ë‹ˆë‹¤.'); return; }
            // ë™ì¼ëª… ì¤‘ë³µ ì²´í¬(ìì‹  ì œì™¸)
            if (platformData.some((p, i) => i !== index && p.name === newName.trim())) {
                showModal('ì˜¤ë¥˜', 'ì´ë¯¸ ì¡´ì¬í•˜ëŠ” í”Œë«í¼ëª…ì…ë‹ˆë‹¤.');
                return;
            }
            const { error } = await supabaseClient
                .from('platforms')
                .update({ name: newName.trim(), fee: newFee })
                .eq('id', row.id)
                .eq('business_number', currentUser.businessNumber);
            if (error) { showModal('ì˜¤ë¥˜', 'ìˆ˜ì •ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.'); return; }
            await reloadAllData();
            showModal('ì„±ê³µ', 'í”Œë«í¼ì´ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.');
        }
        async function deleteSale(index) {
            const row = salesData.slice(-50).reverse()[index];
            if (!row) return; if (!confirm('ë§¤ì¶œ ê¸°ë¡ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
            const { error } = await supabaseClient.from('sales').delete().eq('id', row.id).eq('business_number', currentUser.businessNumber);
            if (error) { showModal('ì˜¤ë¥˜', 'ì‚­ì œ ì‹¤íŒ¨'); return; }
            await reloadAllData();
            updateSalesTable();
            updateDashboard();
        }

        // ìƒí’ˆ ë“±ë¡
        async function handleProductSubmit(e) {
            e.preventDefault();
            const matchingLines = (document.getElementById('productMatching').value || '').split('\n').filter(l => l.trim());
            const rec = {
                business_number: currentUser.businessNumber,
                name: document.getElementById('productName').value,
                cost: parseFloat(document.getElementById('productCost').value),
                platform: document.getElementById('productPlatform').value,
                price: parseFloat(document.getElementById('productPrice').value),
                matching: matchingLines
            };
            const exists = productData.find(p => p.name === rec.name && p.platform === rec.platform);
            if (exists) { showModal('ì˜¤ë¥˜', 'ê°™ì€ í”Œë«í¼ì— ë™ì¼í•œ ìƒí’ˆì´ ì´ë¯¸ ì¡´ì¬í•©ë‹ˆë‹¤.'); return; }
            const { error } = await supabaseClient.from('products').insert([rec]);
            if (error) { showModal('ì˜¤ë¥˜', 'ìƒí’ˆ ë“±ë¡ ì‹¤íŒ¨'); return; }
            (document.getElementById('productForm')).reset();
            await reloadAllData();
            updateProductTable();
            showModal('ì„±ê³µ', 'ìƒí’ˆì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤!');
        }
        async function deleteProduct(index) {
            const row = productData[index]; if (!row) return;
            if (!confirm('ìƒí’ˆì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
            const { error } = await supabaseClient.from('products').delete().eq('id', row.id).eq('business_number', currentUser.businessNumber);
            if (error) { showModal('ì˜¤ë¥˜', 'ì‚­ì œ ì‹¤íŒ¨'); return; }
            await reloadAllData();
            updateProductTable();
        }

        // ì§€ì¶œ ë“±ë¡
        async function handleExpenseSubmit(e) {
            e.preventDefault();
            const rec = {
                business_number: currentUser.businessNumber,
                date: document.getElementById('expenseDate').value,
                type: document.getElementById('expenseType').value,
                category: document.getElementById('expenseCategory').value,
                amount: parseFloat(document.getElementById('expenseAmount').value),
                description: document.getElementById('expenseDescription').value || '',
                registered_at: new Date().toISOString()
            };
            const { error } = await supabaseClient.from('expenses').insert([rec]);
            if (error) { showModal('ì˜¤ë¥˜', 'ì§€ì¶œ ë“±ë¡ ì‹¤íŒ¨'); return; }
            (document.getElementById('expenseForm')).reset();
            document.getElementById('expenseDate').value = new Date().toISOString().split('T')[0];
            await reloadAllData();
            updateExpenseTable();
            updateDashboard();
            showModal('ì„±ê³µ', 'ì§€ì¶œì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤!');
        }
        async function deleteExpense(index) {
            const row = expenseData.slice(-50).reverse()[index]; if (!row) return;
            if (!confirm('ì§€ì¶œ ê¸°ë¡ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
            const { error } = await supabaseClient.from('expenses').delete().eq('id', row.id).eq('business_number', currentUser.businessNumber);
            if (error) { showModal('ì˜¤ë¥˜', 'ì‚­ì œ ì‹¤íŒ¨'); return; }
            await reloadAllData();
            updateExpenseTable();
            updateDashboard();
        }

        // í…Œì´ë¸” ë Œë”ë§
        function updateAllTables() { updateSalesTable(); updateProductTable(); updateExpenseTable(); updatePlatformTable(); }
        function updateSalesTable() {
            const tbody = document.getElementById('salesTableBody');
            tbody.innerHTML = '';
            salesData.slice(-50).reverse().forEach((sale, index) => {
                const totalSales = (sale.price || 0) * (sale.quantity || 0);
                const vat = totalSales * 0.1;
                const platformInfo = platformData.find(p => p.name === sale.platform);
                const feeRate = platformInfo ? platformInfo.fee / 100 : 0;
                const fee = totalSales * feeRate;
                const totalCost = ((sale.cost || 0) * (sale.quantity || 0)) + (sale.shipping || 0);
                const profit = totalSales - vat - totalCost - fee;
                const profitRate = totalSales > 0 ? (profit / totalSales * 100) : 0;
                const tr = tbody.insertRow();
                tr.innerHTML = `
                    <td>${sale.date || ''}</td>
                    <td>${sale.registered_at ? new Date(sale.registered_at).toLocaleDateString() : ''}</td>
                    <td>${sale.platform || ''}</td>
                    <td>${sale.product_name || ''}</td>
                    <td>${sale.option || ''}</td>
                    <td>${sale.order_number || ''}</td>
                    <td>${fmtKRW(totalSales)}</td>
                    <td>${fmtKRW(vat)}</td>
                    <td>${fmtKRW((sale.cost || 0) * (sale.quantity || 0))}</td>
                    <td>${fmtKRW(fee)}</td>
                    <td>${fmtKRW(sale.shipping || 0)}</td>
                    <td style="color:${profit >= 0 ? '#16a34a' : '#ef4444'}; font-weight:700;">${fmtKRW(profit)}</td>
                    <td style="color:${profitRate >= 0 ? '#16a34a' : '#ef4444'}; font-weight:700;">${profitRate.toFixed(1)}%</td>
                    <td><button class="btn" style="padding:6px 10px; font-size:12px; background:#f56565; color:#fff;" onclick="deleteSale(${index})">ì‚­ì œ</button></td>`;
            });
        }
        function updateProductTable() {
            const tbody = document.getElementById('productTableBody');
            tbody.innerHTML = '';
            productData.forEach((product, index) => {
                const platformInfo = platformData.find(p => p.name === product.platform);
                const feeRate = platformInfo ? platformInfo.fee / 100 : 0;
                const expectedProfit = (product.price || 0) - ((product.price || 0) * 0.1) - (product.cost || 0) - ((product.price || 0) * feeRate);
                const expectedProfitRate = (product.price || 0) > 0 ? (expectedProfit / product.price * 100) : 0;
                const tr = tbody.insertRow();
                tr.innerHTML = `
                    <td>${product.name || ''}</td>
                    <td>${product.platform || ''}</td>
                    <td>${fmtKRW(product.cost || 0)}</td>
                    <td>${fmtKRW(product.price || 0)}</td>
                    <td style="color:${expectedProfitRate >= 0 ? '#16a34a' : '#ef4444'}; font-weight:700;">${expectedProfitRate.toFixed(1)}%</td>
                    <td>
                        <button class="btn btn-secondary" style="padding:6px 10px; font-size:12px;" onclick="alert('ìˆ˜ì • ê¸°ëŠ¥ì€ ì¶”í›„ ì œê³µë©ë‹ˆë‹¤.')">ìˆ˜ì •</button>
                        <button class="btn" style="padding:6px 10px; font-size:12px; background:#f56565; color:#fff;" onclick="deleteProduct(${index})">ì‚­ì œ</button>
                    </td>`;
            });
        }
        function updateExpenseTable() {
            const tbody = document.getElementById('expenseTableBody');
            tbody.innerHTML = '';
            const totalExpense = expenseData.reduce((s, e) => s + (e.amount || 0), 0);
            const businessExpense = expenseData.filter(e => e.type === 'ì‚¬ì—…').reduce((s, e) => s + (e.amount || 0), 0);
            const personalExpense = expenseData.filter(e => e.type === 'ê°œì¸').reduce((s, e) => s + (e.amount || 0), 0);
            document.getElementById('totalExpense').textContent = fmtKRW(totalExpense);
            document.getElementById('businessExpense').textContent = fmtKRW(businessExpense);
            document.getElementById('personalExpense').textContent = fmtKRW(personalExpense);
            expenseData.slice(-50).reverse().forEach((expense, index) => {
                const tr = tbody.insertRow();
                tr.innerHTML = `
                    <td>${expense.date || ''}</td>
                    <td><span class="badge" style="background:${expense.type === 'ì‚¬ì—…' ? '#16a34a' : '#f59e0b'}; color:#fff; padding:4px 8px; border-radius:12px; font-size:12px;">${expense.type || ''}</span></td>
                    <td>${expense.category || ''}</td>
                    <td style="color:#ef4444; font-weight:700;">${fmtKRW(expense.amount || 0)}</td>
                    <td>${expense.description || ''}</td>
                    <td><button class="btn" style="padding:6px 10px; font-size:12px; background:#f56565; color:#fff;" onclick="deleteExpense(${index})">ì‚­ì œ</button></td>`;
            });
        }

        // ë‚ ì§œ í•„í„°
        function initializeDateFilter() {
            const today = new Date();
            const firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
            document.getElementById('startDate').value = firstDay.toISOString().split('T')[0];
            document.getElementById('endDate').value = today.toISOString().split('T')[0];
            document.getElementById('startDate').addEventListener('change', updateDashboard);
            document.getElementById('endDate').addEventListener('change', updateDashboard);
        }
        function setDateFilter(type, btn) {
            const today = new Date();
            let startDate = null, endDate = today;
            document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
            if (btn) btn.classList.add('active');
            switch (type) {
                case 'today': startDate = today; break;
                case 'month': startDate = new Date(today.getFullYear(), today.getMonth(), 1); break;
                case 'year': startDate = new Date(today.getFullYear(), 0, 1); break;
                case 'all': startDate = new Date(2020, 0, 1); break;
            }
            if (startDate) {
                document.getElementById('startDate').value = startDate.toISOString().split('T')[0];
                document.getElementById('endDate').value = endDate.toISOString().split('T')[0];
                updateDashboard();
            }
        }
        function resetDateFilter() {
            document.getElementById('startDate').value = '';
            document.getElementById('endDate').value = '';
            document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
            updateDashboard();
        }

        // ëŒ€ì‹œë³´ë“œ ë° ì°¨íŠ¸
        function updateDashboard() {
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            const filteredSales = salesData.filter(s => (!startDate || s.date >= startDate) && (!endDate || s.date <= endDate));
            const filteredExpenses = expenseData.filter(e => (!startDate || e.date >= startDate) && (!endDate || e.date <= endDate));
            const today = new Date().toISOString().split('T')[0];
            const todaySales = salesData.filter(s => s.date === today).reduce((sum, s) => sum + (s.price || 0) * (s.quantity || 0), 0);
            const monthProfit = filteredSales.reduce((sum, sale) => {
                const totalSales = (sale.price || 0) * (sale.quantity || 0);
                const vat = totalSales * 0.1;
                const platformInfo = platformData.find(p => p.name === sale.platform);
                const feeRate = platformInfo ? platformInfo.fee / 100 : 0;
                const fee = totalSales * feeRate;
                const totalCost = ((sale.cost || 0) * (sale.quantity || 0)) + (sale.shipping || 0);
                return sum + (totalSales - vat - totalCost - fee);
            }, 0);
            const totalRevenue = filteredSales.reduce((s, sale) => s + ((sale.price || 0) * (sale.quantity || 0)), 0);
            const profitRate = totalRevenue > 0 ? (monthProfit / totalRevenue * 100) : 0;
            const activePlatforms = new Set(filteredSales.map(s => s.platform)).size;
            document.getElementById('todaySales').textContent = fmtKRW(todaySales);
            document.getElementById('monthProfit').textContent = fmtKRW(monthProfit);
            document.getElementById('profitRate').textContent = `${profitRate.toFixed(1)}%`;
            document.getElementById('activePlatforms').textContent = activePlatforms;
            updateDashboardCharts(filteredSales, filteredExpenses);
        }
        function updateDashboardCharts(salesDataF, expenseDataF) {
            updateMonthlySalesChart(salesDataF);
            updateDailySalesChart(salesDataF);
            updatePlatformSalesChart(salesDataF);
            updateExpenseChart(expenseDataF);
        }
        function updateMonthlySalesChart(data) {
            const ctx = document.getElementById('monthlySalesChart').getContext('2d');
            const monthly = {};
            data.forEach(sale => { const m = (sale.date || '').substring(0,7); monthly[m] = (monthly[m] || 0) + (sale.price || 0) * (sale.quantity || 0); });
            const labels = Object.keys(monthly).sort(); const values = labels.map(m => monthly[m]);
            if (charts.monthlySales) charts.monthlySales.destroy();
            charts.monthlySales = new Chart(ctx, { type: 'line', data: { labels, datasets: [{ label: 'ì›”ë³„ ë§¤ì¶œ', data: values, borderColor: '#667eea', backgroundColor: 'rgba(102,126,234,0.1)', tension: 0.4, fill: true }] }, options: { responsive: true, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, ticks: { callback: v => 'â‚©' + Number(v).toLocaleString() } } } } });
        }
        function updateDailySalesChart(data) {
            const ctx = document.getElementById('dailySalesChart').getContext('2d');
            const daily = {}; const last7 = []; for (let i=6;i>=0;i--){ const d=new Date(); d.setDate(d.getDate()-i); const s=d.toISOString().split('T')[0]; last7.push(s); daily[s]=0; }
            data.forEach(sale => { if (daily.hasOwnProperty(sale.date)) daily[sale.date] += (sale.price||0)*(sale.quantity||0); });
            const values = last7.map(d => daily[d]); const labels = last7.map(s => { const d=new Date(s); return (d.getMonth()+1) + '/' + d.getDate(); });
            if (charts.dailySales) charts.dailySales.destroy();
            charts.dailySales = new Chart(ctx, { type: 'bar', data: { labels, datasets: [{ label: 'ì¼ë³„ ë§¤ì¶œ', data: values, backgroundColor: 'rgba(102,126,234,0.85)', borderColor: '#667eea', borderWidth: 1 }] }, options: { responsive: true, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, ticks: { callback: v => 'â‚©' + Number(v).toLocaleString() } } } } });
        }
        function updatePlatformSalesChart(data) {
            const ctx = document.getElementById('platformSalesChart').getContext('2d');
            const agg = {}; data.forEach(s => { agg[s.platform] = (agg[s.platform] || 0) + (s.price||0)*(s.quantity||0); });
            const labels = Object.keys(agg); const values = Object.values(agg); const colors = ['#667eea','#764ba2','#f093fb','#f5576c','#4facfe','#00f2fe'];
            if (charts.platformSales) charts.platformSales.destroy();
            charts.platformSales = new Chart(ctx, { type: 'doughnut', data: { labels, datasets: [{ data: values, backgroundColor: colors.slice(0, labels.length), borderWidth: 2, borderColor: '#fff' }] }, options: { responsive: true, plugins: { legend: { position: 'bottom' } } } });
        }
        function updateExpenseChart(data) {
            const ctx = document.getElementById('expenseChart').getContext('2d');
            const cat = {}; data.forEach(e => { cat[e.category] = (cat[e.category] || 0) + (e.amount || 0); });
            const labels = Object.keys(cat); const values = Object.values(cat); const colors = ['#fa709a','#fee140','#a8edea','#fed6e3','#d299c2','#fef9d3'];
            if (charts.expense) charts.expense.destroy();
            charts.expense = new Chart(ctx, { type: 'bar', data: { labels, datasets: [{ label: 'ì§€ì¶œ ê¸ˆì•¡', data: values, backgroundColor: colors.slice(0, labels.length), borderWidth: 1 }] }, options: { responsive: true, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, ticks: { callback: v => 'â‚©' + Number(v).toLocaleString() } } } } });
        }
        function updateReportsCharts() {
            const totalSales = salesData.reduce((s, r) => s + (r.price||0)*(r.quantity||0), 0);
            const totalProfit = salesData.reduce((s, r) => {
                const ts = (r.price||0)*(r.quantity||0); const vat=ts*0.1; const pf=platformData.find(p=>p.name===r.platform); const fr=pf?pf.fee/100:0; const fee=ts*fr; const tc=(r.cost||0)*(r.quantity||0)+(r.shipping||0); return s + (ts - vat - tc - fee);
            }, 0);
            const avgPR = totalSales>0 ? (totalProfit/totalSales*100) : 0; const totalCount = salesData.length;
            document.getElementById('reportTotalSales').textContent = fmtKRW(totalSales);
            document.getElementById('reportTotalProfit').textContent = fmtKRW(totalProfit);
            document.getElementById('reportAvgProfitRate').textContent = `${avgPR.toFixed(1)}%`;
            document.getElementById('reportTotalCount').textContent = totalCount;
            updateReportCharts();
        }
        function updateReportCharts() {
            // ì›”ë³„ ë§¤ì¶œ/ìˆœìµ
            const ctx1 = document.getElementById('reportMonthlySalesProfit').getContext('2d');
            const monthlyStats = {};
            salesData.forEach(s => {
                const m = (s.date||'').substring(0,7); if (!monthlyStats[m]) monthlyStats[m] = { sales:0, profit:0 };
                const ts=(s.price||0)*(s.quantity||0); const vat=ts*0.1; const pf=platformData.find(p=>p.name===s.platform); const fr=pf?pf.fee/100:0; const fee=ts*fr; const tc=(s.cost||0)*(s.quantity||0)+(s.shipping||0); const pr=ts - vat - tc - fee;
                monthlyStats[m].sales += ts; monthlyStats[m].profit += pr;
            });
            const months = Object.keys(monthlyStats).sort(); const salesValues = months.map(m=>monthlyStats[m].sales); const profitValues = months.map(m=>monthlyStats[m].profit);
            if (charts.reportMonthlySalesProfit) charts.reportMonthlySalesProfit.destroy();
            charts.reportMonthlySalesProfit = new Chart(ctx1, { type: 'line', data: { labels: months, datasets: [ { label:'ë§¤ì¶œ', data:salesValues, borderColor:'#667eea', backgroundColor:'rgba(102,126,234,0.1)', yAxisID:'y' }, { label:'ìˆœìµ', data:profitValues, borderColor:'#16a34a', backgroundColor:'rgba(22,163,74,0.1)', yAxisID:'y' } ] }, options: { responsive:true, scales:{ y:{ beginAtZero:true, ticks:{ callback:v=>'â‚©'+Number(v).toLocaleString() } } } } });

            // í”Œë«í¼ë³„ ì„±ê³¼ (ë§¤ì¶œ vs ìˆœìµ)
            const ctx2 = document.getElementById('reportPlatformPerformance').getContext('2d');
            const platformStats = {};
            salesData.forEach(s => {
                const k = s.platform || 'ê¸°íƒ€';
                if (!platformStats[k]) platformStats[k] = { sales:0, profit:0 };
                const ts=(s.price||0)*(s.quantity||0); const vat=ts*0.1; const pf=platformData.find(p=>p.name===s.platform); const fr=pf?pf.fee/100:0; const fee=ts*fr; const tc=(s.cost||0)*(s.quantity||0)+(s.shipping||0); const pr=ts - vat - tc - fee;
                platformStats[k].sales += ts; platformStats[k].profit += pr;
            });
            const platLabels = Object.keys(platformStats); const platSales = platLabels.map(k=>platformStats[k].sales); const platProfit = platLabels.map(k=>platformStats[k].profit);
            if (charts.reportPlatformPerformance) charts.reportPlatformPerformance.destroy();
            charts.reportPlatformPerformance = new Chart(ctx2, { type: 'bar', data: { labels: platLabels, datasets: [ { label:'ë§¤ì¶œ', data:platSales, backgroundColor:'rgba(102,126,234,0.8)' }, { label:'ìˆœìµ', data:platProfit, backgroundColor:'rgba(22,163,74,0.8)' } ] }, options: { responsive:true, scales:{ y:{ beginAtZero:true, ticks:{ callback:v=>'â‚©'+Number(v).toLocaleString() } } } } });

            // ìƒìœ„ íŒë§¤ ìƒí’ˆ (ë§¤ì¶œ ê¸°ì¤€ Top 10)
            const ctx3 = document.getElementById('reportTopProducts').getContext('2d');
            const productStats = {};
            salesData.forEach(s => {
                const k = s.product_name || 'ê¸°íƒ€';
                if (!productStats[k]) productStats[k] = { sales:0, profit:0 };
                const ts=(s.price||0)*(s.quantity||0); const vat=ts*0.1; const pf=platformData.find(p=>p.name===s.platform); const fr=pf?pf.fee/100:0; const fee=ts*fr; const tc=(s.cost||0)*(s.quantity||0)+(s.shipping||0); const pr=ts - vat - tc - fee;
                productStats[k].sales += ts; productStats[k].profit += pr;
            });
            const sortedProducts = Object.entries(productStats).sort((a,b)=>b[1].sales - a[1].sales).slice(0,10);
            const prodLabels = sortedProducts.map(([k])=>k); const prodSales = sortedProducts.map(([,v])=>v.sales); const prodProfit = sortedProducts.map(([,v])=>v.profit);
            if (charts.reportTopProducts) charts.reportTopProducts.destroy();
            charts.reportTopProducts = new Chart(ctx3, { type: 'bar', data: { labels: prodLabels, datasets: [ { label:'ë§¤ì¶œ', data:prodSales, backgroundColor:'rgba(102,126,234,0.8)' }, { label:'ìˆœìµ', data:prodProfit, backgroundColor:'rgba(22,163,74,0.8)' } ] }, options: { indexAxis:'y', responsive:true, scales:{ x:{ beginAtZero:true, ticks:{ callback:v=>'â‚©'+Number(v).toLocaleString() } } } } });

            // ìˆ˜ìµë¥  ë¶„í¬
            const ctx4 = document.getElementById('reportProfitDistribution').getContext('2d');
            const buckets = { '<0%':0, '0~10%':0, '10~20%':0, '20~30%':0, '30~50%':0, '50%+':0 };
            salesData.forEach(s => {
                const ts=(s.price||0)*(s.quantity||0); if (ts<=0) return; const vat=ts*0.1; const pf=platformData.find(p=>p.name===s.platform); const fr=pf?pf.fee/100:0; const fee=ts*fr; const tc=(s.cost||0)*(s.quantity||0)+(s.shipping||0); const pr=ts - vat - tc - fee; const rate = pr/ts*100;
                if (rate < 0) buckets['<0%']++; else if (rate < 10) buckets['0~10%']++; else if (rate < 20) buckets['10~20%']++; else if (rate < 30) buckets['20~30%']++; else if (rate < 50) buckets['30~50%']++; else buckets['50%+']++;
            });
            const distLabels = Object.keys(buckets); const distValues = distLabels.map(k=>buckets[k]);
            if (charts.reportProfitDistribution) charts.reportProfitDistribution.destroy();
            charts.reportProfitDistribution = new Chart(ctx4, { type: 'bar', data: { labels: distLabels, datasets: [ { label:'ê±´ìˆ˜', data: distValues, backgroundColor:'rgba(99,102,241,0.85)' } ] }, options: { responsive:true, plugins:{ legend:{ display:false } }, scales:{ y:{ beginAtZero:true } } } });
        }

        // íŒŒì¼ ì—…ë¡œë“œ(ë”ë¯¸)
        function setupFileUpload() {
            const salesUploadArea = document.getElementById('salesUploadArea');
            const salesFileInput = document.getElementById('salesExcelFile');
            salesUploadArea.addEventListener('click', () => salesFileInput.click());
            salesUploadArea.addEventListener('dragover', (e)=>{ e.preventDefault(); salesUploadArea.classList.add('dragover'); });
            salesUploadArea.addEventListener('dragleave', ()=> salesUploadArea.classList.remove('dragover'));
            salesUploadArea.addEventListener('drop', (e)=>{ e.preventDefault(); salesUploadArea.classList.remove('dragover'); if (e.dataTransfer.files.length>0) salesFileInput.files = e.dataTransfer.files; });
            salesFileInput.addEventListener('change', (e)=>{ const f=e.target.files[0]; if (f) salesUploadArea.querySelector('p').textContent = `ì„ íƒëœ íŒŒì¼: ${f.name}`; });
            const productUploadArea = document.getElementById('productUploadArea');
            const productFileInput = document.getElementById('productExcelFile');
            productUploadArea.addEventListener('click', () => productFileInput.click());
            productUploadArea.addEventListener('dragover', (e)=>{ e.preventDefault(); productUploadArea.classList.add('dragover'); });
            productUploadArea.addEventListener('dragleave', ()=> productUploadArea.classList.remove('dragover'));
            productUploadArea.addEventListener('drop', (e)=>{ e.preventDefault(); productUploadArea.classList.remove('dragover'); if (e.dataTransfer.files.length>0) productFileInput.files = e.dataTransfer.files; });
            productFileInput.addEventListener('change', (e)=>{ const f=e.target.files[0]; if (f) productUploadArea.querySelector('p').textContent = `ì„ íƒëœ íŒŒì¼: ${f.name}`; });
        }
        function processSalesExcel() {
            const fi = document.getElementById('salesExcelFile');
            if (!fi.files[0]) { showModal('ì˜¤ë¥˜','íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.'); return; }
            // ì‹¤ì œ íŒŒì„œëŠ” ë¯¸êµ¬í˜„ ìƒíƒœì´ë¯€ë¡œ, ì—¬ê¸°ì„œëŠ” CSV ê°€ì • ë° ê°„ë‹¨ íŒŒì‹± ì˜ˆì‹œë¥¼ ì œì‹œí•©ë‹ˆë‹¤.
            const file = fi.files[0];
            const reader = new FileReader();
            reader.onload = async () => {
                try {
                    const text = reader.result || '';
                    // ê°„ë‹¨ CSV ê°€ì •: ì²« ì¤„ í—¤ë”, ì´í›„ ì»¬ëŸ¼ì— ì˜¨ë¼ì¸ìƒí’ˆëª…/í”Œë«í¼ ì¡´ì¬
                    const lines = text.split(/\r?\n/).filter(l=>l.trim());
                    if (lines.length < 2) { showModal('ì˜¤ë¥˜','ë°ì´í„° í–‰ì´ ì—†ìŠµë‹ˆë‹¤.'); return; }
                    const header = lines[0].split(',').map(h=>h.trim());
                    const nameIdx = header.findIndex(h => /(ìƒí’ˆëª…|ì˜¨ë¼ì¸ìƒí’ˆëª…)/.test(h));
                    const platIdx = header.findIndex(h => /(ì‡¼í•‘ëª°|í”Œë«í¼)/.test(h));
                    const unknowns = [];
                    for (let i=1;i<lines.length;i++) {
                        const cols = lines[i].split(',');
                        const pname = (cols[nameIdx] || '').trim();
                        const pplat = (cols[platIdx] || '').trim();
                        if (!isKnownProductName(pname, pplat)) unknowns.push(`${pplat ? pplat+':' : ''}${pname}`);
                    }
                    if (unknowns.length) {
                        showModal('í™•ì¸ í•„ìš”', `ë“±ë¡ë˜ì§€ ì•Šì€ ìƒí’ˆëª…: \n- ${unique(unknowns).join('\n- ')}`);
                        return;
                    }
                    showModal('ì„±ê³µ','ì—‘ì…€ íŒŒì¼ì´ ì„±ê³µì ìœ¼ë¡œ ê²€ì¦ë˜ì—ˆìŠµë‹ˆë‹¤.');
                } catch (e) {
                    showModal('ì˜¤ë¥˜','íŒŒì¼ ê²€ì¦ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                } finally {
                    fi.value='';
                    document.querySelector('#salesUploadArea p').textContent='ğŸ“ ì—‘ì…€ íŒŒì¼ì„ ë“œë˜ê·¸í•˜ê±°ë‚˜ í´ë¦­í•˜ì—¬ ì—…ë¡œë“œ';
                }
            };
            reader.readAsText(file, 'utf-8');
        }
        function processProductExcel() { const fi=document.getElementById('productExcelFile'); if (!fi.files[0]) { showModal('ì˜¤ë¥˜','íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.'); return; } showModal('ì²˜ë¦¬ì¤‘','ìƒí’ˆ ì—‘ì…€ íŒŒì¼ì„ ì²˜ë¦¬í•˜ê³  ìˆìŠµë‹ˆë‹¤...'); setTimeout(()=>{ showModal('ì„±ê³µ','ìƒí’ˆì´ ì„±ê³µì ìœ¼ë¡œ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.'); fi.value=''; document.querySelector('#productUploadArea p').textContent='ğŸ“ ìƒí’ˆ ì—‘ì…€ íŒŒì¼ì„ ë“œë˜ê·¸í•˜ê±°ë‚˜ í´ë¦­í•˜ì—¬ ì—…ë¡œë“œ'; updateProductTable(); }, 1200); }
        function downloadProductTemplate() { const csv = "ì‹¤ì œìƒí’ˆëª…,ê¸°ë³¸ì›ê°€,ê¶Œì¥íŒë§¤ê°€,ì¹´í…Œê³ ë¦¬,ë§¤ì¹­ìƒí’ˆëª…\në¬´ì„ ì´ì–´í°,30000,59000,ì „ìì œí’ˆ,ì¿ íŒ¡:ë¸”ë£¨íˆ¬ìŠ¤ ë¬´ì„  ì´ì–´í°;11ë²ˆê°€:ë¬´ì„  ì´ì–´í°\nìŠ¤ë§ˆíŠ¸ì›Œì¹˜,80000,150000,ì „ìì œí’ˆ,ì¿ íŒ¡:ìŠ¤ë§ˆíŠ¸ì›Œì¹˜;11ë²ˆê°€:ìŠ¤ë§ˆíŠ¸ì›Œì¹˜ GPS"; const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'}); const link=document.createElement('a'); const url=URL.createObjectURL(blob); link.href=url; link.download='ìƒí’ˆë“±ë¡_í…œí”Œë¦¿.csv'; link.style.visibility='hidden'; document.body.appendChild(link); link.click(); document.body.removeChild(link); }
    </script>
</body>
</html>


