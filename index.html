<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>매출 관리 시스템</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="./env.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        /* 로그인 화면 */
        #loginScreen { display: flex; justify-content: center; align-items: center; min-height: 100vh; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .login-form { background: rgba(255, 255, 255, 0.95); padding: 40px; border-radius: 20px; box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1); backdrop-filter: blur(10px); width: 400px; text-align: center; }
        .login-form h1 { color: #333; margin-bottom: 30px; font-size: 2.2rem; font-weight: 600; }
        .form-group { margin-bottom: 20px; text-align: left; position: relative; }
        .form-group label { display: block; margin-bottom: 8px; color: #555; font-weight: 500; }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 12px 16px; border: 2px solid #e1e5e9; border-radius: 10px; font-size: 16px; transition: border-color 0.3s ease; }
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus { outline: none; border-color: #667eea; }
        .btn { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; padding: 12px 30px; border-radius: 10px; cursor: pointer; font-size: 16px; font-weight: 600; transition: transform 0.25s ease, box-shadow 0.25s ease, background 0.25s ease; margin: 5px; }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 10px 20px rgba(0,0,0,0.2); }
        .btn-secondary { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); }
        .btn-success { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); }
        /* 메인 시스템 */
        #mainSystem { display: none; background: #f8fafc; min-height: 100vh; }
        .header { background: rgba(255,255,255,0.95); backdrop-filter: blur(10px); padding: 12px 16px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); position: sticky; top: 0; z-index: 200; }
        .header-content { display: flex; justify-content: space-between; align-items: center; max-width: 1200px; margin: 0 auto; gap: 12px; }
        .logo { font-size: 1.4rem; font-weight: 700; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .user-info { display: flex; align-items: center; gap: 10px; }
        .user-name { color: #333; font-weight: 600; }
        /* 모바일 상단 네비게이션 */
        .top-nav { background: rgba(255,255,255,0.9); backdrop-filter: blur(10px); }
        .top-nav-inner { max-width: 1200px; margin: 0 auto; display: flex; align-items: center; justify-content: space-between; padding: 8px 10px; gap: 8px; }
        .tabs-scroll { display: flex; overflow-x: auto; gap: 6px; scrollbar-width: thin; }
        .tab-btn { background: none; border: none; padding: 12px 14px; cursor: pointer; font-size: 14px; font-weight: 600; color: #666; border-bottom: 3px solid transparent; transition: all 0.3s ease; white-space: nowrap; border-radius: 8px; }
        .tab-btn.active { color: #667eea; border-bottom-color: #667eea; background: rgba(102,126,234,0.08); }
        .tab-btn:hover { color: #667eea; background: rgba(102,126,234,0.12); }
        /* 탭 콘텐츠 */
        .tab-content { display: none; padding: 20px 12px; max-width: 1200px; margin: 0 auto; }
        .tab-content.active { display: block; }
        .section-header { display: flex; align-items: center; gap: 12px; margin-bottom: 18px; padding-bottom: 12px; border-bottom: 2px solid #e2e8f0; }
        .section-icon { width: 36px; height: 36px; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 18px; color: white; }
        .section-title { font-size: 1.4rem; font-weight: 700; color: #2d3748; }
        .card { background: rgba(255,255,255,0.95); backdrop-filter: blur(10px); border-radius: 14px; padding: 18px; margin-bottom: 18px; box-shadow: 0 10px 25px rgba(0,0,0,0.08); border: 1px solid rgba(255,255,255,0.2); transition: box-shadow 0.25s ease, transform 0.25s ease; }
        .card:hover { box-shadow: 0 14px 32px rgba(0,0,0,0.12); transform: translateY(-2px); }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 12px; margin-bottom: 18px; }
        .stat-card { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: #fff; padding: 18px; border-radius: 14px; text-align: center; box-shadow: 0 10px 25px rgba(102, 126, 234, 0.25); }
        .stat-value { font-size: 1.8rem; font-weight: 800; margin-bottom: 6px; }
        .stat-label { font-size: 0.95rem; opacity: 0.95; }
        .filter-section { background: rgba(255,255,255,0.95); padding: 16px; border-radius: 14px; margin-bottom: 18px; box-shadow: 0 5px 15px rgba(0,0,0,0.06); }
        .filter-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 10px; align-items: end; }
        .filter-buttons { display: flex; gap: 8px; flex-wrap: wrap; margin-top: 10px; }
        .filter-btn { background: #e2e8f0; color: #4a5568; border: none; padding: 8px 12px; border-radius: 8px; cursor: pointer; font-size: 13px; font-weight: 600; transition: all 0.3s ease; }
        .filter-btn.active, .filter-btn:hover { background: #667eea; color: #fff; }
        .table-container { overflow-x: auto; border-radius: 12px; box-shadow: 0 10px 25px rgba(0,0,0,0.08); }
        table { width: 100%; border-collapse: collapse; background: white; border-radius: 12px; overflow: hidden; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #e2e8f0; font-size: 14px; }
        th { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; font-weight: 700; position: sticky; top: 0; }
        tr:hover { background: rgba(102,126,234,0.06); }
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 12px; }
        .chart-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 14px; margin-top: 12px; }
        .chart-container { background: rgba(255,255,255,0.95); padding: 16px; border-radius: 14px; box-shadow: 0 10px 25px rgba(0,0,0,0.08); }
        .upload-area { border: 2px dashed #667eea; border-radius: 12px; padding: 20px; text-align: center; cursor: pointer; transition: all 0.3s ease; margin: 12px 0; }
        .upload-area:hover { background: rgba(102,126,234,0.06); }
        .upload-area.dragover { background: rgba(102,126,234,0.1); border-color: #764ba2; }
        .calculation-panel { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color: #fff; padding: 16px; border-radius: 14px; margin: 12px 0; }
        .calc-row { display: flex; justify-content: space-between; margin: 6px 0; padding: 4px 0; }
        .calc-row.total { border-top: 2px solid rgba(255,255,255,0.35); margin-top: 8px; padding-top: 8px; font-weight: 700; font-size: 1.05rem; }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); backdrop-filter: blur(5px); }
        .modal-content { background: white; margin: 15% auto; padding: 18px; border-radius: 14px; width: 92%; max-width: 500px; box-shadow: 0 20px 40px rgba(0,0,0,0.18); }
        .modal h3 { color: #667eea; margin-bottom: 10px; }
        .close { color: #aaa; float: right; font-size: 26px; font-weight: bold; cursor: pointer; line-height: 1; }
        .close:hover { color: #667eea; }
        @media (max-width: 768px) {
            .login-form { width: 92%; padding: 26px 18px; }
            .header-content { flex-direction: column; align-items: stretch; }
            .tab-btn { padding: 10px 12px; font-size: 13px; }
            th, td { padding: 10px 8px; font-size: 13px; }
        }
    </style>
    <script>
        // 환경값에서 Supabase 초기화
        let supabaseClient = null;
        function initSupabase() {
            if (!window.SUPABASE_URL || !window.SUPABASE_ANON_KEY) {
                console.error('Supabase 환경변수가 없습니다. env.js를 확인하세요.');
                return null;
            }
            return window.supabase.createClient(window.SUPABASE_URL, window.SUPABASE_ANON_KEY);
        }
    </script>
</head>
<body>
    <!-- 로그인 화면 -->
    <div id="loginScreen">
        <div class="login-form">
            <h1>💼 매출 관리</h1>
            <form id="loginForm">
                <div class="form-group">
                    <label for="businessNumber">사업자등록번호</label>
                    <input type="text" id="businessNumber" placeholder="000-00-00000" maxlength="12" required />
                </div>
                <div class="form-group">
                    <label for="businessName">사업체명</label>
                    <input type="text" id="businessName" placeholder="사업체명을 입력하세요" required />
                </div>
                <div class="form-group">
                    <label for="ownerName">대표자명</label>
                    <input type="text" id="ownerName" placeholder="대표자명을 입력하세요" required />
                </div>
                <button type="submit" class="btn">로그인 / 등록</button>
            </form>
        </div>
    </div>

    <!-- 메인 시스템 -->
    <div id="mainSystem">
        <div class="header">
            <div class="header-content">
                <div class="logo">💼 매출 관리 시스템</div>
                <div class="user-info">
                    <span class="user-name" id="displayBusinessName"></span>
                    <button class="btn btn-secondary" id="logoutBtn">로그아웃</button>
                </div>
            </div>
        </div>

        <!-- 상단 모바일 네비게이션 -->
        <div class="top-nav">
            <div class="top-nav-inner">
                <div class="tabs-scroll">
                    <button class="tab-btn active" data-tab="dashboard">📊 대시보드</button>
                    <button class="tab-btn" data-tab="sales">💰 매출 등록</button>
                    <button class="tab-btn" data-tab="products">📦 상품 관리</button>
                    <button class="tab-btn" data-tab="expenses">💸 지출 관리</button>
                    <button class="tab-btn" data-tab="reports">📈 리포트</button>
                </div>
            </div>
        </div>

        <!-- 대시보드 -->
        <div class="tab-content active" id="dashboard">
            <div class="section-header">
                <div class="section-icon" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">📊</div>
                <div class="section-title">대시보드</div>
            </div>
            <div class="filter-section">
                <h3>📅 날짜 필터</h3>
                <div class="filter-grid">
                    <div class="form-group">
                        <label>시작일</label>
                        <input type="date" id="startDate" />
                    </div>
                    <div class="form-group">
                        <label>종료일</label>
                        <input type="date" id="endDate" />
                    </div>
                </div>
                <div class="filter-buttons">
                    <button class="filter-btn" data-range="today">오늘</button>
                    <button class="filter-btn active" data-range="month">이번달</button>
                    <button class="filter-btn" data-range="year">올해</button>
                    <button class="filter-btn" data-range="all">전체</button>
                    <button class="filter-btn" id="resetDate">초기화</button>
                </div>
            </div>
            <div class="stats-grid">
                <div class="stat-card"><div class="stat-value" id="todaySales">₩0</div><div class="stat-label">오늘의 매출</div></div>
                <div class="stat-card"><div class="stat-value" id="monthProfit">₩0</div><div class="stat-label">이번달 순익</div></div>
                <div class="stat-card"><div class="stat-value" id="profitRate">0%</div><div class="stat-label">수익률</div></div>
                <div class="stat-card"><div class="stat-value" id="activePlatforms">0</div><div class="stat-label">활성 플랫폼 수</div></div>
            </div>
            <div class="chart-grid">
                <div class="chart-container"><h3>📈 월별 매출 추이</h3><canvas id="monthlySalesChart"></canvas></div>
                <div class="chart-container"><h3>📅 일별 매출</h3><canvas id="dailySalesChart"></canvas></div>
                <div class="chart-container"><h3>🏪 플랫폼별 매출 비중</h3><canvas id="platformSalesChart"></canvas></div>
                <div class="chart-container"><h3>💸 지출 분석</h3><canvas id="expenseChart"></canvas></div>
            </div>
        </div>

        <!-- 매출 등록 -->
        <div class="tab-content" id="sales">
            <div class="section-header">
                <div class="section-icon" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">💰</div>
                <div class="section-title">매출 등록</div>
            </div>
            <div class="card">
                <h3>✏️ 수동 등록</h3>
                <form id="salesForm">
                    <div class="form-grid">
                        <div class="form-group"><label>플랫폼 *</label><select id="salesPlatform" required></select></div>
                        <div class="form-group">
                            <label>상품명 *</label>
                            <input type="text" id="salesProductName" placeholder="상품명 또는 매칭명으로 검색" required />
                            <div id="productSuggestions" style="display:none; position:absolute; background:#fff; border:1px solid #ddd; border-radius:10px; max-height:240px; overflow-y:auto; width:100%; z-index:10;"></div>
                        </div>
                        <div class="form-group"><label>옵션명</label><input type="text" id="salesOption" placeholder="옵션명 (선택)" /></div>
                        <div class="form-group"><label>판매가 *</label><input type="number" id="salesPrice" placeholder="판매가" required /></div>
                        <div class="form-group"><label>배송비</label><input type="number" id="salesShipping" value="0" /></div>
                        <div class="form-group"><label>수수료(%)</label><input type="number" id="salesFeePercent" step="0.1" placeholder="플랫폼 기본값 자동 반영 / 수동 가능" /></div>
                        <div class="form-group"><label>판매일 *</label><input type="date" id="salesDate" required /></div>
                        <div class="form-group"><label>주문번호</label><input type="text" id="salesOrderNumber" placeholder="주문번호 (선택)" /></div>
                    </div>
                    <div class="calculation-panel">
                        <h4>💰 실시간 계산</h4>
                        <div class="calc-row"><span>매출(판매가):</span><span id="calcTotalSales">₩0</span></div>
                        <div class="calc-row"><span>부가세 (10%):</span><span id="calcVAT">₩0</span></div>
                        <div class="calc-row"><span>수수료:</span><span id="calcFee">₩0</span></div>
                        <div class="calc-row"><span>배송비:</span><span id="calcShip">₩0</span></div>
                        <div class="calc-row total"><span>순익(추정):</span><span id="calcProfit">₩0</span></div>
                        <div class="calc-row"><span>수익률(추정):</span><span id="calcProfitRate">0%</span></div>
                    </div>
                    <button type="submit" class="btn btn-success">💾 매출 등록</button>
                </form>
            </div>
            <div class="card">
                <h3>📄 엑셀 업로드</h3>
                <p>포맷: 쇼핑몰, 쇼핑몰주문번호, 온라인상품명, 옵션, 주문수량</p>
                <div class="upload-area" id="salesUploadArea"><p>📁 엑셀 파일을 드래그하거나 클릭하여 업로드</p><input type="file" id="salesExcelFile" accept=".xlsx,.xls,.csv" style="display: none;" /></div>
                <button class="btn" id="chooseSalesFile">📁 파일 선택</button>
                <button class="btn btn-success" id="processSalesBtn">📊 업로드 처리</button>
            </div>
            <div class="card">
                <h3>📋 매출 목록</h3>
                <div class="table-container">
                    <table id="salesTable">
                        <thead>
                            <tr>
                                <th>판매일</th><th>등록일</th><th>플랫폼</th><th>상품명</th><th>옵션</th><th>주문번호</th><th>판매가</th><th>부가세</th><th>원가</th><th>수수료</th><th>배송비</th><th>순익</th><th>수익률</th><th>관리</th>
                            </tr>
                        </thead>
                        <tbody id="salesTableBody"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- 상품 관리 -->
        <div class="tab-content" id="products">
            <div class="section-header">
                <div class="section-icon" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">📦</div>
                <div class="section-title">상품 관리</div>
            </div>
            <div class="card">
                <h3>➕ 상품 등록</h3>
                <form id="productForm">
                    <div class="form-grid">
                        <div class="form-group"><label>상품명 *</label><input type="text" id="productName" required placeholder="실제 상품명" /></div>
                        <div class="form-group"><label>기본 원가 *</label><input type="number" id="productCost" required placeholder="기본 원가" /></div>
                        <div class="form-group"><label>플랫폼 *</label><select id="productPlatform" required></select></div>
                        <div class="form-group"><label>플랫폼별 판매가 *</label><input type="number" id="productPrice" required placeholder="판매가" /></div>
                    </div>
                    <div class="form-group">
                        <label>매칭 상품명</label>
                        <textarea id="productMatching" placeholder="플랫폼:상품명 형태로 입력 (줄바꿈으로 여러개 입력 가능)&#10;예시:&#10;쿠팡:상품명A&#10;11번가:상품명B" rows="4" style="width: 100%; resize: vertical;"></textarea>
                    </div>
                    <button type="submit" class="btn btn-success">💾 상품 등록</button>
                </form>
            </div>
            <div class="card">
                <h3>🏪 플랫폼 관리</h3>
                <div style="display: flex; gap: 10px; margin-bottom: 12px; flex-wrap: wrap;">
                    <input type="text" id="newPlatformName" placeholder="플랫폼명" style="flex: 1; min-width: 180px;" />
                    <input type="number" id="newPlatformFee" placeholder="기본 수수료 (%)" step="0.1" style="flex: 1; min-width: 180px;" />
                    <button class="btn" id="addPlatformBtn">➕ 플랫폼 추가</button>
                </div>
                <div class="table-container">
                    <table id="platformTable">
                        <thead><tr><th>플랫폼명</th><th>기본 수수료 (%)</th><th>관리</th></tr></thead>
                        <tbody id="platformTableBody"></tbody>
                    </table>
                </div>
            </div>
            <div class="card">
                <h3>📊 상품 일괄 등록</h3>
                <p>포맷: 실제상품명, 기본원가, 권장판매가, 매칭상품명</p>
                <button class="btn btn-secondary" id="downloadProductTemplateBtn">📥 템플릿 다운로드</button>
                <div class="upload-area" id="productUploadArea"><p>📁 상품 엑셀 파일을 드래그하거나 클릭하여 업로드</p><input type="file" id="productExcelFile" accept=".xlsx,.xls,.csv" style="display:none;" /></div>
                <button class="btn" id="chooseProductFile">📁 파일 선택</button>
                <button class="btn btn-success" id="processProductBtn">📊 업로드 처리</button>
            </div>
            <div class="card">
                <h3>📦 상품 목록</h3>
                <div class="table-container">
                    <table id="productTable">
                        <thead><tr><th>상품명</th><th>플랫폼</th><th>원가</th><th>판매가</th><th>예상 수익률</th><th>관리</th></tr></thead>
                        <tbody id="productTableBody"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- 지출 관리 -->
        <div class="tab-content" id="expenses">
            <div class="section-header">
                <div class="section-icon" style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);">💸</div>
                <div class="section-title">지출 관리</div>
            </div>
            <div class="card">
                <h3>➕ 지출 등록</h3>
                <form id="expenseForm">
                    <div class="form-grid">
                        <div class="form-group"><label>구분 *</label><select id="expenseType" required><option value="">구분 선택</option><option value="사업">사업</option><option value="개인">개인</option></select></div>
                        <div class="form-group"><label>카테고리 *</label><select id="expenseCategory" required><option value="">카테고리 선택</option><option value="재료비">재료비</option><option value="운송비">운송비</option><option value="광고비">광고비</option><option value="사무용품">사무용품</option><option value="통신비">통신비</option><option value="임대료">임대료</option><option value="기타">기타</option></select></div>
                        <div class="form-group"><label>금액 *</label><input type="number" id="expenseAmount" required placeholder="지출 금액" /></div>
                        <div class="form-group"><label>날짜 *</label><input type="date" id="expenseDate" required /></div>
                        <div class="form-group" style="grid-column: 1 / -1;"><label>내용</label><input type="text" id="expenseDescription" placeholder="지출 내용 설명" /></div>
                    </div>
                    <button type="submit" class="btn btn-success">💾 지출 등록</button>
                </form>
            </div>
            <div class="card">
                <h3>💸 지출 목록</h3>
                <div style="margin-bottom: 12px; display:flex; gap:14px; flex-wrap:wrap;">
                    <span><strong>총 지출:</strong> <span id="totalExpense">₩0</span></span>
                    <span><strong>사업 지출:</strong> <span id="businessExpense">₩0</span></span>
                    <span><strong>개인 지출:</strong> <span id="personalExpense">₩0</span></span>
                </div>
                <div class="table-container">
                    <table id="expenseTable">
                        <thead><tr><th>날짜</th><th>구분</th><th>카테고리</th><th>금액</th><th>내용</th><th>관리</th></tr></thead>
                        <tbody id="expenseTableBody"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- 리포트 -->
        <div class="tab-content" id="reports">
            <div class="section-header">
                <div class="section-icon" style="background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);">📈</div>
                <div class="section-title">리포트</div>
            </div>
            <div class="stats-grid">
                <div class="stat-card"><div class="stat-value" id="reportTotalSales">₩0</div><div class="stat-label">총 매출</div></div>
                <div class="stat-card" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);"><div class="stat-value" id="reportTotalProfit">₩0</div><div class="stat-label">총 순익</div></div>
                <div class="stat-card" style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);"><div class="stat-value" id="reportAvgProfitRate">0%</div><div class="stat-label">평균 수익률</div></div>
                <div class="stat-card" style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);"><div class="stat-value" id="reportTotalCount">0</div><div class="stat-label">판매 건수</div></div>
            </div>
            <div class="chart-grid">
                <div class="chart-container"><h3>📈 월별 매출 vs 순익</h3><canvas id="reportMonthlySalesProfit"></canvas></div>
                <div class="chart-container"><h3>🏪 플랫폼별 성과</h3><canvas id="reportPlatformPerformance"></canvas></div>
                <div class="chart-container"><h3>📦 상위 판매 상품</h3><canvas id="reportTopProducts"></canvas></div>
                <div class="chart-container"><h3>💰 수익률 분포</h3><canvas id="reportProfitDistribution"></canvas></div>
            </div>
        </div>
    </div>

    <!-- 모달 창 -->
    <div id="modal" class="modal">
        <div class="modal-content">
            <span class="close" id="modalClose">&times;</span>
            <h3 id="modalTitle">알림</h3>
            <div id="modalMessage"></div>
            <div style="text-align: center; margin-top: 12px;"><button class="btn" id="modalOk">확인</button></div>
        </div>
    </div>

    <script>
        // 전역 상태
        let currentUser = null;
        let salesData = [];
        let productData = [];
        let platformData = [];
        let expenseData = [];
        let charts = {};

        // 유틸
        const fmtKRW = (n) => `₩${Math.round(n || 0).toLocaleString()}`;
        const unique = (arr) => Array.from(new Set(arr));

        // 상품 검증 유틸: 플랫폼/매칭까지 고려해 등록 여부 확인
        function isKnownProductName(inputName, platformOpt) {
            const name = (inputName || '').trim();
            if (!name) return false;
            return productData.some(p => {
                if ((p.name || '') === name && (!platformOpt || p.platform === platformOpt)) return true;
                if (!Array.isArray(p.matching)) return false;
                return p.matching.some(m => {
                    const raw = (m || '').trim();
                    if (!raw) return false;
                    if (raw.includes(':')) {
                        const [plat, alias] = raw.split(':');
                        if (platformOpt) return plat === platformOpt && alias === name;
                        return alias === name || raw === name;
                    }
                    return raw === name;
                });
            });
        }

        // 모달
        function showModal(title, message) {
            document.getElementById('modalTitle').textContent = title;
            document.getElementById('modalMessage').textContent = message;
            document.getElementById('modal').style.display = 'block';
        }
        function closeModal() { document.getElementById('modal').style.display = 'none'; }

        // 초기화
        document.addEventListener('DOMContentLoaded', async () => {
            supabaseClient = initSupabase();
            bindStaticEvents();
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('salesDate').value = today;
            document.getElementById('expenseDate').value = today;
            const savedUser = JSON.parse(localStorage.getItem('currentUser') || 'null');
            if (savedUser) { currentUser = savedUser; await postLogin(); }
        });

        function bindStaticEvents() {
            document.getElementById('loginForm').addEventListener('submit', handleLogin);
            document.getElementById('logoutBtn').addEventListener('click', logout);
            document.getElementById('salesForm').addEventListener('input', calculateSales);
            document.getElementById('salesForm').addEventListener('submit', handleSalesSubmit);
            document.getElementById('productForm').addEventListener('submit', handleProductSubmit);
            document.getElementById('expenseForm').addEventListener('submit', handleExpenseSubmit);
            document.getElementById('modalClose').addEventListener('click', closeModal);
            document.getElementById('modalOk').addEventListener('click', closeModal);
            document.getElementById('resetDate').addEventListener('click', resetDateFilter);
            document.getElementById('chooseSalesFile').addEventListener('click', () => document.getElementById('salesExcelFile').click());
            document.getElementById('chooseProductFile').addEventListener('click', () => document.getElementById('productExcelFile').click());
            document.getElementById('processSalesBtn').addEventListener('click', processSalesExcel);
            document.getElementById('processProductBtn').addEventListener('click', processProductExcel);
            document.getElementById('downloadProductTemplateBtn').addEventListener('click', downloadProductTemplate);
            // 탭
            document.querySelectorAll('.tab-btn').forEach(btn => btn.addEventListener('click', () => showTab(btn.dataset.tab, btn)));
            // 날짜 퀵필터
            document.querySelectorAll('.filter-btn[data-range]').forEach(btn => btn.addEventListener('click', () => setDateFilter(btn.dataset.range, btn)));
            // 업로드 드래그
            setupFileUpload();
            // 자동완성 외부 클릭 닫기
            document.addEventListener('click', (e) => {
                const suggestions = document.getElementById('productSuggestions');
                const input = document.getElementById('salesProductName');
                if (suggestions && !suggestions.contains(e.target) && e.target !== input) { suggestions.style.display = 'none'; }
            });
            // 자동완성 입력 바인딩
            document.getElementById('salesProductName').addEventListener('input', (e) => searchProducts(e.target.value));
        }

        async function handleLogin(e) {
            e.preventDefault();
            const businessNumber = document.getElementById('businessNumber').value;
            const businessName = document.getElementById('businessName').value;
            const ownerName = document.getElementById('ownerName').value;
            if (!businessNumber || !businessName || !ownerName) { showModal('오류', '모든 필드를 입력해주세요.'); return; }
            const numberOnly = businessNumber.replace(/[^\d]/g, '');
            if (numberOnly.length !== 10) { showModal('오류', '올바른 사업자등록번호를 입력해주세요.'); return; }
            currentUser = { businessNumber, businessName, ownerName, loginDate: new Date().toISOString() };
            localStorage.setItem('currentUser', JSON.stringify(currentUser));
            await postLogin();
            showModal('성공', '로그인되었습니다!');
        }

        async function postLogin() {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('mainSystem').style.display = 'block';
            document.getElementById('displayBusinessName').textContent = currentUser.businessName;
            initializeDateFilter();
            await ensureDefaultPlatforms();
            await reloadAllData();
            updateAllTables();
            updateDashboard();
        }

        function logout() {
            if (confirm('로그아웃 하시겠습니까?')) {
                localStorage.removeItem('currentUser');
                currentUser = null;
                document.getElementById('loginScreen').style.display = 'flex';
                document.getElementById('mainSystem').style.display = 'none';
                document.getElementById('loginForm').reset();
            }
        }

        function showTab(tabName, btn) {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            if (btn) btn.classList.add('active');
            document.getElementById(tabName).classList.add('active');
            if (tabName === 'reports') setTimeout(() => updateReportsCharts(), 100);
        }

        // Supabase CRUD helpers
        async function reloadAllData() {
            const bn = currentUser.businessNumber;
            const [salesRes, productRes, platformRes, expenseRes] = await Promise.all([
                supabaseClient.from('sales').select('*').eq('business_number', bn).order('date', { ascending: true }),
                supabaseClient.from('products').select('*').eq('business_number', bn).order('name'),
                supabaseClient.from('platforms').select('*').eq('business_number', bn).order('name'),
                supabaseClient.from('expenses').select('*').eq('business_number', bn).order('date', { ascending: true })
            ]);
            if (salesRes.error) console.error(salesRes.error);
            if (productRes.error) console.error(productRes.error);
            if (platformRes.error) console.error(platformRes.error);
            if (expenseRes.error) console.error(expenseRes.error);
            salesData = salesRes.data || [];
            productData = productRes.data || [];
            platformData = platformRes.data || [];
            expenseData = expenseRes.data || [];
            updatePlatformSelects();
        }

        async function ensureDefaultPlatforms() {
            const bn = currentUser.businessNumber;
            const { data, error } = await supabaseClient.from('platforms').select('id').eq('business_number', bn).limit(1);
            if (error) { console.error(error); return; }
            if (!data || data.length === 0) {
                const defaults = [
                    { name: '쿠팡', fee: 8.8 },
                    { name: '11번가', fee: 9.0 },
                    { name: '지마켓', fee: 9.5 },
                    { name: '옥션', fee: 9.5 },
                    { name: '네이버스토어팜', fee: 5.5 }
                ].map(p => ({ ...p, business_number: bn }));
                const { error: insErr } = await supabaseClient.from('platforms').insert(defaults);
                if (insErr) console.error(insErr);
            }
        }

        // 플랫폼
        function updatePlatformSelects() {
            ['salesPlatform', 'productPlatform'].forEach(selectId => {
                const select = document.getElementById(selectId);
                const cur = select.value;
                select.innerHTML = '<option value="">플랫폼 선택</option>';
                platformData.forEach(p => { const o = document.createElement('option'); o.value = p.name; o.textContent = p.name; select.appendChild(o); });
                select.value = cur;
            });
            updatePlatformTable();
        }
        document.getElementById('addPlatformBtn').addEventListener('click', async () => {
            const name = document.getElementById('newPlatformName').value.trim();
            const fee = parseFloat(document.getElementById('newPlatformFee').value);
            if (!name || isNaN(fee)) { showModal('오류', '플랫폼명과 수수료를 입력해주세요.'); return; }
            if (platformData.find(p => p.name === name)) { showModal('오류', '이미 존재하는 플랫폼입니다.'); return; }
            const { error } = await supabaseClient.from('platforms').insert([{ name, fee, business_number: currentUser.businessNumber }]);
            if (error) { showModal('오류', '플랫폼 추가 실패'); return; }
            document.getElementById('newPlatformName').value = '';
            document.getElementById('newPlatformFee').value = '';
            await reloadAllData();
            showModal('성공', '플랫폼이 추가되었습니다.');
        });
        async function deletePlatform(index) {
            const row = platformData[index]; if (!row) return;
            if (!confirm('플랫폼을 삭제하시겠습니까?')) return;
            const { error } = await supabaseClient.from('platforms').delete().eq('id', row.id).eq('business_number', currentUser.businessNumber);
            if (error) { showModal('오류', '삭제 실패'); return; }
            await reloadAllData();
        }
        function updatePlatformTable() {
            const tbody = document.getElementById('platformTableBody');
            tbody.innerHTML = '';
            platformData.forEach((platform, index) => {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${platform.name}</td>
                    <td>${platform.fee}%</td>
                    <td>
                        <button class="btn btn-secondary" style="padding:6px 10px; font-size:12px;" onclick="editPlatform(${index})">수정</button>
                        <button class="btn" style="padding:6px 10px; font-size:12px; background:#f56565; color:#fff;" onclick="deletePlatform(${index})">삭제</button>
                    </td>`;
            });
        }

        // 자동완성
        function searchProducts(query) {
            const suggestions = document.getElementById('productSuggestions');
            if (!query || query.length < 1) { suggestions.style.display = 'none'; return; }
            const q = query.toLowerCase();
            const matches = productData.filter(product => {
                const n = (product.name || '').toLowerCase();
                const m = Array.isArray(product.matching) ? product.matching.map(x => (x||'').toLowerCase()).join(' ') : '';
                return n.includes(q) || m.includes(q);
            });
            if (matches.length > 0) {
                suggestions.innerHTML = matches.map(product =>
                    `<div onclick="selectProduct('${(product.name || '').replace(/'/g, "\'")}')" style="padding:10px; cursor:pointer; border-bottom:1px solid #eee;">${product.name} (${product.platform}) - ${fmtKRW(product.price)}</div>`
                ).join('');
                suggestions.style.display = 'block';
            } else { suggestions.style.display = 'none'; }
        }
        function selectProduct(productName) {
            const product = productData.find(p => p.name === productName);
            if (product) {
                document.getElementById('salesProductName').value = product.name || '';
                document.getElementById('salesPlatform').value = product.platform || '';
                document.getElementById('salesPrice').value = product.price || 0;
                // 플랫폼 기본 수수료 자동 반영
                const pf = platformData.find(p => p.name === product.platform);
                document.getElementById('salesFeePercent').value = pf ? pf.fee : '';
                calculateSales();
            }
            document.getElementById('productSuggestions').style.display = 'none';
        }

        // 계산
        function calculateSales() {
            const price = parseFloat(document.getElementById('salesPrice').value) || 0;
            const shipping = parseFloat(document.getElementById('salesShipping').value) || 0;
            const platform = document.getElementById('salesPlatform').value;
            const manualFeePercent = document.getElementById('salesFeePercent').value;
            const platformInfo = platformData.find(p => p.name === platform);
            const feeRate = (manualFeePercent !== '' ? parseFloat(manualFeePercent) : (platformInfo ? platformInfo.fee : 0)) / 100;
            const totalSales = price;
            const vat = totalSales * 0.1;
            const fee = totalSales * (isNaN(feeRate) ? 0 : feeRate);
            const profit = totalSales - vat - shipping - fee; // 간소화된 추정
            const profitRate = totalSales > 0 ? (profit / totalSales * 100) : 0;
            document.getElementById('calcTotalSales').textContent = fmtKRW(totalSales);
            document.getElementById('calcVAT').textContent = fmtKRW(vat);
            document.getElementById('calcFee').textContent = fmtKRW(fee);
            document.getElementById('calcShip').textContent = fmtKRW(shipping);
            document.getElementById('calcProfit').textContent = fmtKRW(profit);
            document.getElementById('calcProfitRate').textContent = `${profitRate.toFixed(1)}%`;
        }

        // 매출 등록
        async function handleSalesSubmit(e) {
            e.preventDefault();
            const feePercent = document.getElementById('salesFeePercent').value;
            const rec = {
                business_number: currentUser.businessNumber,
                date: document.getElementById('salesDate').value,
                platform: document.getElementById('salesPlatform').value,
                product_name: document.getElementById('salesProductName').value,
                price: parseFloat(document.getElementById('salesPrice').value),
                quantity: 1,
                cost: 0,
                shipping: parseFloat(document.getElementById('salesShipping').value) || 0,
                option: document.getElementById('salesOption').value || '',
                order_number: document.getElementById('salesOrderNumber').value || '',
                fee_percent: feePercent === '' ? null : parseFloat(feePercent),
                registered_at: new Date().toISOString()
            };
            // 미등록 상품명 검증
            const platformName = rec.platform;
            const productKnown = isKnownProductName(rec.product_name, platformName);
            if (!productKnown) {
                showModal('확인 필요', `상품 관리에 등록되지 않은 상품명입니다: "${rec.product_name}"`);
                return;
            }
            const { error } = await supabaseClient.from('sales').insert([rec]);
            if (error) { showModal('오류', '매출 등록 실패'); return; }
            (document.getElementById('salesForm')).reset();
            document.getElementById('salesDate').value = new Date().toISOString().split('T')[0];
            calculateSales();
            await reloadAllData();
            updateSalesTable();
            updateDashboard();
            showModal('성공', '매출이 등록되었습니다!');
        }

        // 플랫폼 수정
        async function editPlatform(index) {
            const row = platformData[index]; if (!row) return;
            const newName = prompt('플랫폼명을 입력하세요', row.name);
            if (newName === null) return;
            const feeStr = prompt('기본 수수료(%)를 입력하세요', String(row.fee));
            if (feeStr === null) return;
            const newFee = parseFloat(feeStr);
            if (!newName.trim() || isNaN(newFee)) { showModal('오류', '올바른 값이 아닙니다.'); return; }
            // 동일명 중복 체크(자신 제외)
            if (platformData.some((p, i) => i !== index && p.name === newName.trim())) {
                showModal('오류', '이미 존재하는 플랫폼명입니다.');
                return;
            }
            const { error } = await supabaseClient
                .from('platforms')
                .update({ name: newName.trim(), fee: newFee })
                .eq('id', row.id)
                .eq('business_number', currentUser.businessNumber);
            if (error) { showModal('오류', '수정에 실패했습니다.'); return; }
            await reloadAllData();
            showModal('성공', '플랫폼이 수정되었습니다.');
        }
        async function deleteSale(index) {
            const row = salesData.slice(-50).reverse()[index];
            if (!row) return; if (!confirm('매출 기록을 삭제하시겠습니까?')) return;
            const { error } = await supabaseClient.from('sales').delete().eq('id', row.id).eq('business_number', currentUser.businessNumber);
            if (error) { showModal('오류', '삭제 실패'); return; }
            await reloadAllData();
            updateSalesTable();
            updateDashboard();
        }

        // 상품 등록
        async function handleProductSubmit(e) {
            e.preventDefault();
            const matchingLines = (document.getElementById('productMatching').value || '').split('\n').filter(l => l.trim());
            const rec = {
                business_number: currentUser.businessNumber,
                name: document.getElementById('productName').value,
                cost: parseFloat(document.getElementById('productCost').value),
                platform: document.getElementById('productPlatform').value,
                price: parseFloat(document.getElementById('productPrice').value),
                matching: matchingLines
            };
            const exists = productData.find(p => p.name === rec.name && p.platform === rec.platform);
            if (exists) { showModal('오류', '같은 플랫폼에 동일한 상품이 이미 존재합니다.'); return; }
            const { error } = await supabaseClient.from('products').insert([rec]);
            if (error) { showModal('오류', '상품 등록 실패'); return; }
            (document.getElementById('productForm')).reset();
            await reloadAllData();
            updateProductTable();
            showModal('성공', '상품이 등록되었습니다!');
        }
        async function deleteProduct(index) {
            const row = productData[index]; if (!row) return;
            if (!confirm('상품을 삭제하시겠습니까?')) return;
            const { error } = await supabaseClient.from('products').delete().eq('id', row.id).eq('business_number', currentUser.businessNumber);
            if (error) { showModal('오류', '삭제 실패'); return; }
            await reloadAllData();
            updateProductTable();
        }

        // 지출 등록
        async function handleExpenseSubmit(e) {
            e.preventDefault();
            const rec = {
                business_number: currentUser.businessNumber,
                date: document.getElementById('expenseDate').value,
                type: document.getElementById('expenseType').value,
                category: document.getElementById('expenseCategory').value,
                amount: parseFloat(document.getElementById('expenseAmount').value),
                description: document.getElementById('expenseDescription').value || '',
                registered_at: new Date().toISOString()
            };
            const { error } = await supabaseClient.from('expenses').insert([rec]);
            if (error) { showModal('오류', '지출 등록 실패'); return; }
            (document.getElementById('expenseForm')).reset();
            document.getElementById('expenseDate').value = new Date().toISOString().split('T')[0];
            await reloadAllData();
            updateExpenseTable();
            updateDashboard();
            showModal('성공', '지출이 등록되었습니다!');
        }
        async function deleteExpense(index) {
            const row = expenseData.slice(-50).reverse()[index]; if (!row) return;
            if (!confirm('지출 기록을 삭제하시겠습니까?')) return;
            const { error } = await supabaseClient.from('expenses').delete().eq('id', row.id).eq('business_number', currentUser.businessNumber);
            if (error) { showModal('오류', '삭제 실패'); return; }
            await reloadAllData();
            updateExpenseTable();
            updateDashboard();
        }

        // 테이블 렌더링
        function updateAllTables() { updateSalesTable(); updateProductTable(); updateExpenseTable(); updatePlatformTable(); }
        function updateSalesTable() {
            const tbody = document.getElementById('salesTableBody');
            tbody.innerHTML = '';
            salesData.slice(-50).reverse().forEach((sale, index) => {
                const totalSales = (sale.price || 0) * (sale.quantity || 0);
                const vat = totalSales * 0.1;
                const platformInfo = platformData.find(p => p.name === sale.platform);
                const feeRate = platformInfo ? platformInfo.fee / 100 : 0;
                const fee = totalSales * feeRate;
                const totalCost = ((sale.cost || 0) * (sale.quantity || 0)) + (sale.shipping || 0);
                const profit = totalSales - vat - totalCost - fee;
                const profitRate = totalSales > 0 ? (profit / totalSales * 100) : 0;
                const tr = tbody.insertRow();
                tr.innerHTML = `
                    <td>${sale.date || ''}</td>
                    <td>${sale.registered_at ? new Date(sale.registered_at).toLocaleDateString() : ''}</td>
                    <td>${sale.platform || ''}</td>
                    <td>${sale.product_name || ''}</td>
                    <td>${sale.option || ''}</td>
                    <td>${sale.order_number || ''}</td>
                    <td>${fmtKRW(totalSales)}</td>
                    <td>${fmtKRW(vat)}</td>
                    <td>${fmtKRW((sale.cost || 0) * (sale.quantity || 0))}</td>
                    <td>${fmtKRW(fee)}</td>
                    <td>${fmtKRW(sale.shipping || 0)}</td>
                    <td style="color:${profit >= 0 ? '#16a34a' : '#ef4444'}; font-weight:700;">${fmtKRW(profit)}</td>
                    <td style="color:${profitRate >= 0 ? '#16a34a' : '#ef4444'}; font-weight:700;">${profitRate.toFixed(1)}%</td>
                    <td><button class="btn" style="padding:6px 10px; font-size:12px; background:#f56565; color:#fff;" onclick="deleteSale(${index})">삭제</button></td>`;
            });
        }
        function updateProductTable() {
            const tbody = document.getElementById('productTableBody');
            tbody.innerHTML = '';
            productData.forEach((product, index) => {
                const platformInfo = platformData.find(p => p.name === product.platform);
                const feeRate = platformInfo ? platformInfo.fee / 100 : 0;
                const expectedProfit = (product.price || 0) - ((product.price || 0) * 0.1) - (product.cost || 0) - ((product.price || 0) * feeRate);
                const expectedProfitRate = (product.price || 0) > 0 ? (expectedProfit / product.price * 100) : 0;
                const tr = tbody.insertRow();
                tr.innerHTML = `
                    <td>${product.name || ''}</td>
                    <td>${product.platform || ''}</td>
                    <td>${fmtKRW(product.cost || 0)}</td>
                    <td>${fmtKRW(product.price || 0)}</td>
                    <td style="color:${expectedProfitRate >= 0 ? '#16a34a' : '#ef4444'}; font-weight:700;">${expectedProfitRate.toFixed(1)}%</td>
                    <td>
                        <button class="btn btn-secondary" style="padding:6px 10px; font-size:12px;" onclick="alert('수정 기능은 추후 제공됩니다.')">수정</button>
                        <button class="btn" style="padding:6px 10px; font-size:12px; background:#f56565; color:#fff;" onclick="deleteProduct(${index})">삭제</button>
                    </td>`;
            });
        }
        function updateExpenseTable() {
            const tbody = document.getElementById('expenseTableBody');
            tbody.innerHTML = '';
            const totalExpense = expenseData.reduce((s, e) => s + (e.amount || 0), 0);
            const businessExpense = expenseData.filter(e => e.type === '사업').reduce((s, e) => s + (e.amount || 0), 0);
            const personalExpense = expenseData.filter(e => e.type === '개인').reduce((s, e) => s + (e.amount || 0), 0);
            document.getElementById('totalExpense').textContent = fmtKRW(totalExpense);
            document.getElementById('businessExpense').textContent = fmtKRW(businessExpense);
            document.getElementById('personalExpense').textContent = fmtKRW(personalExpense);
            expenseData.slice(-50).reverse().forEach((expense, index) => {
                const tr = tbody.insertRow();
                tr.innerHTML = `
                    <td>${expense.date || ''}</td>
                    <td><span class="badge" style="background:${expense.type === '사업' ? '#16a34a' : '#f59e0b'}; color:#fff; padding:4px 8px; border-radius:12px; font-size:12px;">${expense.type || ''}</span></td>
                    <td>${expense.category || ''}</td>
                    <td style="color:#ef4444; font-weight:700;">${fmtKRW(expense.amount || 0)}</td>
                    <td>${expense.description || ''}</td>
                    <td><button class="btn" style="padding:6px 10px; font-size:12px; background:#f56565; color:#fff;" onclick="deleteExpense(${index})">삭제</button></td>`;
            });
        }

        // 날짜 필터
        function initializeDateFilter() {
            const today = new Date();
            const firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
            document.getElementById('startDate').value = firstDay.toISOString().split('T')[0];
            document.getElementById('endDate').value = today.toISOString().split('T')[0];
            document.getElementById('startDate').addEventListener('change', updateDashboard);
            document.getElementById('endDate').addEventListener('change', updateDashboard);
        }
        function setDateFilter(type, btn) {
            const today = new Date();
            let startDate = null, endDate = today;
            document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
            if (btn) btn.classList.add('active');
            switch (type) {
                case 'today': startDate = today; break;
                case 'month': startDate = new Date(today.getFullYear(), today.getMonth(), 1); break;
                case 'year': startDate = new Date(today.getFullYear(), 0, 1); break;
                case 'all': startDate = new Date(2020, 0, 1); break;
            }
            if (startDate) {
                document.getElementById('startDate').value = startDate.toISOString().split('T')[0];
                document.getElementById('endDate').value = endDate.toISOString().split('T')[0];
                updateDashboard();
            }
        }
        function resetDateFilter() {
            document.getElementById('startDate').value = '';
            document.getElementById('endDate').value = '';
            document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
            updateDashboard();
        }

        // 대시보드 및 차트
        function updateDashboard() {
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            const filteredSales = salesData.filter(s => (!startDate || s.date >= startDate) && (!endDate || s.date <= endDate));
            const filteredExpenses = expenseData.filter(e => (!startDate || e.date >= startDate) && (!endDate || e.date <= endDate));
            const today = new Date().toISOString().split('T')[0];
            const todaySales = salesData.filter(s => s.date === today).reduce((sum, s) => sum + (s.price || 0) * (s.quantity || 0), 0);
            const monthProfit = filteredSales.reduce((sum, sale) => {
                const totalSales = (sale.price || 0) * (sale.quantity || 0);
                const vat = totalSales * 0.1;
                const platformInfo = platformData.find(p => p.name === sale.platform);
                const feeRate = platformInfo ? platformInfo.fee / 100 : 0;
                const fee = totalSales * feeRate;
                const totalCost = ((sale.cost || 0) * (sale.quantity || 0)) + (sale.shipping || 0);
                return sum + (totalSales - vat - totalCost - fee);
            }, 0);
            const totalRevenue = filteredSales.reduce((s, sale) => s + ((sale.price || 0) * (sale.quantity || 0)), 0);
            const profitRate = totalRevenue > 0 ? (monthProfit / totalRevenue * 100) : 0;
            const activePlatforms = new Set(filteredSales.map(s => s.platform)).size;
            document.getElementById('todaySales').textContent = fmtKRW(todaySales);
            document.getElementById('monthProfit').textContent = fmtKRW(monthProfit);
            document.getElementById('profitRate').textContent = `${profitRate.toFixed(1)}%`;
            document.getElementById('activePlatforms').textContent = activePlatforms;
            updateDashboardCharts(filteredSales, filteredExpenses);
        }
        function updateDashboardCharts(salesDataF, expenseDataF) {
            updateMonthlySalesChart(salesDataF);
            updateDailySalesChart(salesDataF);
            updatePlatformSalesChart(salesDataF);
            updateExpenseChart(expenseDataF);
        }
        function updateMonthlySalesChart(data) {
            const ctx = document.getElementById('monthlySalesChart').getContext('2d');
            const monthly = {};
            data.forEach(sale => { const m = (sale.date || '').substring(0,7); monthly[m] = (monthly[m] || 0) + (sale.price || 0) * (sale.quantity || 0); });
            const labels = Object.keys(monthly).sort(); const values = labels.map(m => monthly[m]);
            if (charts.monthlySales) charts.monthlySales.destroy();
            charts.monthlySales = new Chart(ctx, { type: 'line', data: { labels, datasets: [{ label: '월별 매출', data: values, borderColor: '#667eea', backgroundColor: 'rgba(102,126,234,0.1)', tension: 0.4, fill: true }] }, options: { responsive: true, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, ticks: { callback: v => '₩' + Number(v).toLocaleString() } } } } });
        }
        function updateDailySalesChart(data) {
            const ctx = document.getElementById('dailySalesChart').getContext('2d');
            const daily = {}; const last7 = []; for (let i=6;i>=0;i--){ const d=new Date(); d.setDate(d.getDate()-i); const s=d.toISOString().split('T')[0]; last7.push(s); daily[s]=0; }
            data.forEach(sale => { if (daily.hasOwnProperty(sale.date)) daily[sale.date] += (sale.price||0)*(sale.quantity||0); });
            const values = last7.map(d => daily[d]); const labels = last7.map(s => { const d=new Date(s); return (d.getMonth()+1) + '/' + d.getDate(); });
            if (charts.dailySales) charts.dailySales.destroy();
            charts.dailySales = new Chart(ctx, { type: 'bar', data: { labels, datasets: [{ label: '일별 매출', data: values, backgroundColor: 'rgba(102,126,234,0.85)', borderColor: '#667eea', borderWidth: 1 }] }, options: { responsive: true, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, ticks: { callback: v => '₩' + Number(v).toLocaleString() } } } } });
        }
        function updatePlatformSalesChart(data) {
            const ctx = document.getElementById('platformSalesChart').getContext('2d');
            const agg = {}; data.forEach(s => { agg[s.platform] = (agg[s.platform] || 0) + (s.price||0)*(s.quantity||0); });
            const labels = Object.keys(agg); const values = Object.values(agg); const colors = ['#667eea','#764ba2','#f093fb','#f5576c','#4facfe','#00f2fe'];
            if (charts.platformSales) charts.platformSales.destroy();
            charts.platformSales = new Chart(ctx, { type: 'doughnut', data: { labels, datasets: [{ data: values, backgroundColor: colors.slice(0, labels.length), borderWidth: 2, borderColor: '#fff' }] }, options: { responsive: true, plugins: { legend: { position: 'bottom' } } } });
        }
        function updateExpenseChart(data) {
            const ctx = document.getElementById('expenseChart').getContext('2d');
            const cat = {}; data.forEach(e => { cat[e.category] = (cat[e.category] || 0) + (e.amount || 0); });
            const labels = Object.keys(cat); const values = Object.values(cat); const colors = ['#fa709a','#fee140','#a8edea','#fed6e3','#d299c2','#fef9d3'];
            if (charts.expense) charts.expense.destroy();
            charts.expense = new Chart(ctx, { type: 'bar', data: { labels, datasets: [{ label: '지출 금액', data: values, backgroundColor: colors.slice(0, labels.length), borderWidth: 1 }] }, options: { responsive: true, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, ticks: { callback: v => '₩' + Number(v).toLocaleString() } } } } });
        }
        function updateReportsCharts() {
            const totalSales = salesData.reduce((s, r) => s + (r.price||0)*(r.quantity||0), 0);
            const totalProfit = salesData.reduce((s, r) => {
                const ts = (r.price||0)*(r.quantity||0); const vat=ts*0.1; const pf=platformData.find(p=>p.name===r.platform); const fr=pf?pf.fee/100:0; const fee=ts*fr; const tc=(r.cost||0)*(r.quantity||0)+(r.shipping||0); return s + (ts - vat - tc - fee);
            }, 0);
            const avgPR = totalSales>0 ? (totalProfit/totalSales*100) : 0; const totalCount = salesData.length;
            document.getElementById('reportTotalSales').textContent = fmtKRW(totalSales);
            document.getElementById('reportTotalProfit').textContent = fmtKRW(totalProfit);
            document.getElementById('reportAvgProfitRate').textContent = `${avgPR.toFixed(1)}%`;
            document.getElementById('reportTotalCount').textContent = totalCount;
            updateReportCharts();
        }
        function updateReportCharts() {
            // 월별 매출/순익
            const ctx1 = document.getElementById('reportMonthlySalesProfit').getContext('2d');
            const monthlyStats = {};
            salesData.forEach(s => {
                const m = (s.date||'').substring(0,7); if (!monthlyStats[m]) monthlyStats[m] = { sales:0, profit:0 };
                const ts=(s.price||0)*(s.quantity||0); const vat=ts*0.1; const pf=platformData.find(p=>p.name===s.platform); const fr=pf?pf.fee/100:0; const fee=ts*fr; const tc=(s.cost||0)*(s.quantity||0)+(s.shipping||0); const pr=ts - vat - tc - fee;
                monthlyStats[m].sales += ts; monthlyStats[m].profit += pr;
            });
            const months = Object.keys(monthlyStats).sort(); const salesValues = months.map(m=>monthlyStats[m].sales); const profitValues = months.map(m=>monthlyStats[m].profit);
            if (charts.reportMonthlySalesProfit) charts.reportMonthlySalesProfit.destroy();
            charts.reportMonthlySalesProfit = new Chart(ctx1, { type: 'line', data: { labels: months, datasets: [ { label:'매출', data:salesValues, borderColor:'#667eea', backgroundColor:'rgba(102,126,234,0.1)', yAxisID:'y' }, { label:'순익', data:profitValues, borderColor:'#16a34a', backgroundColor:'rgba(22,163,74,0.1)', yAxisID:'y' } ] }, options: { responsive:true, scales:{ y:{ beginAtZero:true, ticks:{ callback:v=>'₩'+Number(v).toLocaleString() } } } } });

            // 플랫폼별 성과 (매출 vs 순익)
            const ctx2 = document.getElementById('reportPlatformPerformance').getContext('2d');
            const platformStats = {};
            salesData.forEach(s => {
                const k = s.platform || '기타';
                if (!platformStats[k]) platformStats[k] = { sales:0, profit:0 };
                const ts=(s.price||0)*(s.quantity||0); const vat=ts*0.1; const pf=platformData.find(p=>p.name===s.platform); const fr=pf?pf.fee/100:0; const fee=ts*fr; const tc=(s.cost||0)*(s.quantity||0)+(s.shipping||0); const pr=ts - vat - tc - fee;
                platformStats[k].sales += ts; platformStats[k].profit += pr;
            });
            const platLabels = Object.keys(platformStats); const platSales = platLabels.map(k=>platformStats[k].sales); const platProfit = platLabels.map(k=>platformStats[k].profit);
            if (charts.reportPlatformPerformance) charts.reportPlatformPerformance.destroy();
            charts.reportPlatformPerformance = new Chart(ctx2, { type: 'bar', data: { labels: platLabels, datasets: [ { label:'매출', data:platSales, backgroundColor:'rgba(102,126,234,0.8)' }, { label:'순익', data:platProfit, backgroundColor:'rgba(22,163,74,0.8)' } ] }, options: { responsive:true, scales:{ y:{ beginAtZero:true, ticks:{ callback:v=>'₩'+Number(v).toLocaleString() } } } } });

            // 상위 판매 상품 (매출 기준 Top 10)
            const ctx3 = document.getElementById('reportTopProducts').getContext('2d');
            const productStats = {};
            salesData.forEach(s => {
                const k = s.product_name || '기타';
                if (!productStats[k]) productStats[k] = { sales:0, profit:0 };
                const ts=(s.price||0)*(s.quantity||0); const vat=ts*0.1; const pf=platformData.find(p=>p.name===s.platform); const fr=pf?pf.fee/100:0; const fee=ts*fr; const tc=(s.cost||0)*(s.quantity||0)+(s.shipping||0); const pr=ts - vat - tc - fee;
                productStats[k].sales += ts; productStats[k].profit += pr;
            });
            const sortedProducts = Object.entries(productStats).sort((a,b)=>b[1].sales - a[1].sales).slice(0,10);
            const prodLabels = sortedProducts.map(([k])=>k); const prodSales = sortedProducts.map(([,v])=>v.sales); const prodProfit = sortedProducts.map(([,v])=>v.profit);
            if (charts.reportTopProducts) charts.reportTopProducts.destroy();
            charts.reportTopProducts = new Chart(ctx3, { type: 'bar', data: { labels: prodLabels, datasets: [ { label:'매출', data:prodSales, backgroundColor:'rgba(102,126,234,0.8)' }, { label:'순익', data:prodProfit, backgroundColor:'rgba(22,163,74,0.8)' } ] }, options: { indexAxis:'y', responsive:true, scales:{ x:{ beginAtZero:true, ticks:{ callback:v=>'₩'+Number(v).toLocaleString() } } } } });

            // 수익률 분포
            const ctx4 = document.getElementById('reportProfitDistribution').getContext('2d');
            const buckets = { '<0%':0, '0~10%':0, '10~20%':0, '20~30%':0, '30~50%':0, '50%+':0 };
            salesData.forEach(s => {
                const ts=(s.price||0)*(s.quantity||0); if (ts<=0) return; const vat=ts*0.1; const pf=platformData.find(p=>p.name===s.platform); const fr=pf?pf.fee/100:0; const fee=ts*fr; const tc=(s.cost||0)*(s.quantity||0)+(s.shipping||0); const pr=ts - vat - tc - fee; const rate = pr/ts*100;
                if (rate < 0) buckets['<0%']++; else if (rate < 10) buckets['0~10%']++; else if (rate < 20) buckets['10~20%']++; else if (rate < 30) buckets['20~30%']++; else if (rate < 50) buckets['30~50%']++; else buckets['50%+']++;
            });
            const distLabels = Object.keys(buckets); const distValues = distLabels.map(k=>buckets[k]);
            if (charts.reportProfitDistribution) charts.reportProfitDistribution.destroy();
            charts.reportProfitDistribution = new Chart(ctx4, { type: 'bar', data: { labels: distLabels, datasets: [ { label:'건수', data: distValues, backgroundColor:'rgba(99,102,241,0.85)' } ] }, options: { responsive:true, plugins:{ legend:{ display:false } }, scales:{ y:{ beginAtZero:true } } } });
        }

        // 파일 업로드(더미)
        function setupFileUpload() {
            const salesUploadArea = document.getElementById('salesUploadArea');
            const salesFileInput = document.getElementById('salesExcelFile');
            salesUploadArea.addEventListener('click', () => salesFileInput.click());
            salesUploadArea.addEventListener('dragover', (e)=>{ e.preventDefault(); salesUploadArea.classList.add('dragover'); });
            salesUploadArea.addEventListener('dragleave', ()=> salesUploadArea.classList.remove('dragover'));
            salesUploadArea.addEventListener('drop', (e)=>{ e.preventDefault(); salesUploadArea.classList.remove('dragover'); if (e.dataTransfer.files.length>0) salesFileInput.files = e.dataTransfer.files; });
            salesFileInput.addEventListener('change', (e)=>{ const f=e.target.files[0]; if (f) salesUploadArea.querySelector('p').textContent = `선택된 파일: ${f.name}`; });
            const productUploadArea = document.getElementById('productUploadArea');
            const productFileInput = document.getElementById('productExcelFile');
            productUploadArea.addEventListener('click', () => productFileInput.click());
            productUploadArea.addEventListener('dragover', (e)=>{ e.preventDefault(); productUploadArea.classList.add('dragover'); });
            productUploadArea.addEventListener('dragleave', ()=> productUploadArea.classList.remove('dragover'));
            productUploadArea.addEventListener('drop', (e)=>{ e.preventDefault(); productUploadArea.classList.remove('dragover'); if (e.dataTransfer.files.length>0) productFileInput.files = e.dataTransfer.files; });
            productFileInput.addEventListener('change', (e)=>{ const f=e.target.files[0]; if (f) productUploadArea.querySelector('p').textContent = `선택된 파일: ${f.name}`; });
        }
        function processSalesExcel() {
            const fi = document.getElementById('salesExcelFile');
            if (!fi.files[0]) { showModal('오류','파일을 선택해주세요.'); return; }
            // 실제 파서는 미구현 상태이므로, 여기서는 CSV 가정 및 간단 파싱 예시를 제시합니다.
            const file = fi.files[0];
            const reader = new FileReader();
            reader.onload = async () => {
                try {
                    const text = reader.result || '';
                    // 간단 CSV 가정: 첫 줄 헤더, 이후 컬럼에 온라인상품명/플랫폼 존재
                    const lines = text.split(/\r?\n/).filter(l=>l.trim());
                    if (lines.length < 2) { showModal('오류','데이터 행이 없습니다.'); return; }
                    const header = lines[0].split(',').map(h=>h.trim());
                    const nameIdx = header.findIndex(h => /(상품명|온라인상품명)/.test(h));
                    const platIdx = header.findIndex(h => /(쇼핑몰|플랫폼)/.test(h));
                    const unknowns = [];
                    for (let i=1;i<lines.length;i++) {
                        const cols = lines[i].split(',');
                        const pname = (cols[nameIdx] || '').trim();
                        const pplat = (cols[platIdx] || '').trim();
                        if (!isKnownProductName(pname, pplat)) unknowns.push(`${pplat ? pplat+':' : ''}${pname}`);
                    }
                    if (unknowns.length) {
                        showModal('확인 필요', `등록되지 않은 상품명: \n- ${unique(unknowns).join('\n- ')}`);
                        return;
                    }
                    showModal('성공','엑셀 파일이 성공적으로 검증되었습니다.');
                } catch (e) {
                    showModal('오류','파일 검증 중 오류가 발생했습니다.');
                } finally {
                    fi.value='';
                    document.querySelector('#salesUploadArea p').textContent='📁 엑셀 파일을 드래그하거나 클릭하여 업로드';
                }
            };
            reader.readAsText(file, 'utf-8');
        }
        function processProductExcel() { const fi=document.getElementById('productExcelFile'); if (!fi.files[0]) { showModal('오류','파일을 선택해주세요.'); return; } showModal('처리중','상품 엑셀 파일을 처리하고 있습니다...'); setTimeout(()=>{ showModal('성공','상품이 성공적으로 등록되었습니다.'); fi.value=''; document.querySelector('#productUploadArea p').textContent='📁 상품 엑셀 파일을 드래그하거나 클릭하여 업로드'; updateProductTable(); }, 1200); }
        function downloadProductTemplate() { const csv = "실제상품명,기본원가,권장판매가,카테고리,매칭상품명\n무선이어폰,30000,59000,전자제품,쿠팡:블루투스 무선 이어폰;11번가:무선 이어폰\n스마트워치,80000,150000,전자제품,쿠팡:스마트워치;11번가:스마트워치 GPS"; const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'}); const link=document.createElement('a'); const url=URL.createObjectURL(blob); link.href=url; link.download='상품등록_템플릿.csv'; link.style.visibility='hidden'; document.body.appendChild(link); link.click(); document.body.removeChild(link); }
    </script>
</body>
</html>


